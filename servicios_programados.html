<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Avisos y llamadas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="Avisos y llamadas" name="description" />
    <meta content="Themesbrand" name="author" />
    <meta name="keywords" content="Avisos y llamadas, clientes, pedidos, potogas">
    <!-- App favicon -->
    <link rel="shortcut icon"
        href="https://5298967-sb1.app.netsuite.com/core/media/media.nl?id=108997&c=5298967_SB1&h=MqKO6RyzbmQKiMqwc6-9rA2wJSTQZ0yi96oPgnj9KQwozioR&_xt=.ico">

    <!-- Select 2 -->
    <link href="https://themesbrand.com/skote/layouts/assets/libs/select2/css/select2.min.css" rel="stylesheet"
        type="text/css" />

    <!-- Datepicker -->
    <link href="https://themesbrand.com/skote/layouts/assets/libs/bootstrap-datepicker/css/bootstrap-datepicker.min.css"
        rel="stylesheet" type="text/css">
    <link href="https://themesbrand.com/skote/layouts/assets/libs/@chenfengyuan/datepicker/datepicker.min.css"
        rel="stylesheet">

    <!-- Timepicker -->
    <link href="https://themesbrand.com/skote/layouts/assets/libs/bootstrap-timepicker/css/bootstrap-timepicker.min.css"
        rel="stylesheet" type="text/css">

    <!-- DataTables -->
    <link href="https://themesbrand.com/skote/layouts/assets/libs/datatables.net-bs4/css/dataTables.bootstrap4.min.css"
        rel="stylesheet" type="text/css" />
    <!-- <link href="./assets/libs/datatables.net-buttons-bs4/css/buttons.bootstrap4.min.css" rel="stylesheet" type="text/css" />
    <link href="./assets/libs/datatables.net-responsive-bs4/css/responsive.bootstrap4.min.css" rel="stylesheet" type="text/css" />    -->

    <!-- <link rel="stylesheet" href="./assets/libs/@chenfengyuan/datepicker/datepicker.min.css"> -->

    <!-- Bootstrap Css -->
    <link href="https://themesbrand.com/skote/layouts/assets/css/bootstrap.min.css" id="bootstrap-style"
        rel="stylesheet" type="text/css" />
    <!-- Select 2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- Icons Css -->
    <!-- <link href="https://themesbrand.com/skote/layouts/assets/css/icons.min.css" rel="stylesheet" type="text/css" /> -->
    <!-- App Css-->
    <link href="https://themesbrand.com/skote/layouts/assets/css/app.min.css" id="app-style" rel="stylesheet"
        type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        html,
        body {
            font-family: "Roboto", "Helvetica Neue", sans-serif !important;
        }

        .pl-0 {
            padding-left: 0;
        }

        .pr-0 {
            padding-right: 0;
        }

        .btn-flat {
            border-radius: 0;
        }

        .btn-header {
            width: 51px;
            height: 56px;
        }

        .bg-primary-cc {
            background-color: #355da7;
            color: #ffffff;
        }

        button.bg-primary-cc:hover {
            background-color: #456aae;
            color: #ffffff;
        }

        .bg-secondary-cc {
            background-color: #e7792b;
            color: #ffffff;
        }

        button.bg-secondary-cc:hover {
            background-color: #e98640;
            color: #ffffff;
        }

        .bg-success-cc {
            background-color: #2dd36f;
            color: #ffffff;
        }

        button.bg-success-cc:hover {
            background-color: #42d77d;
            color: #ffffff;
        }

        .bg-warning-cc {
            background-color: #ffc409;
            color: #ffffff;
        }

        button.bg-warning-cc:hover {
            background-color: #ffca22;
            color: #ffffff;
        }

        .bg-dark-cc {
            background-color: #222428;
            color: #ffffff;
        }

        button.bg-dark-cc:hover {
            background-color: #222428;
            color: #ffffff;
        }

        .bg-danger-cc {
            background-color: #eb445a;
            color: #ffffff;
        }

        button.bg-danger-cc:hover {
            background-color: #ed576b;
            color: #ffffff;
        }

        #header-title {
            font-size: 28px;
        }

        .ft-12 {
            font-size: 12px;
        }

        .ft-16 {
            font-size: 16px;
        }

        .bg-white {
            background-color: #ffffff;
        }

        .chip {
            display: inline-block;
            padding: 0 25px;
            height: 30px;
            font-size: 16px;
            line-height: 30px;
            border-radius: 25px;
            opacity: 0.8;
            cursor: pointer;
        }

        .chip.bg-primary-cc {
            background-color: rgba(231, 121, 43, 0.08)
        }

        .chip img {
            float: left;
            margin: 0 10px 0 -25px;
            height: 25px;
            width: 25px;
            margin-top: 2.5px;
            border-radius: 50%;
        }

        .w-100 {
            width: 100%;
        }

        .h-100 {
            height: calc(100vh - 56px);
        }

        .form-ptg {
            font-size: 16px;
            border: solid 2px #9d9b99;
            border-radius: 9px;
            padding-left: 9px;
            color: #737373;
            padding-right: 9px;
            width: 100%;
            padding-top: 9px;
            padding-bottom: 9px;
        }

        select.form-ptg {
            padding-top: 11.5px;
            padding-bottom: 11.5px;
        }

        .form-ptg-primary {
            border: solid 2px #355da7;
            color: #355da7;
        }

        .content-input-primary .form-ptg-primary[type="date"]::-webkit-calendar-picker-indicator {
            background: url(https://5298967-sb1.app.netsuite.com/core/media/media.nl?id=108994&c=5298967_SB1&h=TZdf2C4l2Y6fG6GOHYfluLN8kg0dvo3J-bUwrhd1rbdlhL_3) center/80% no-repeat;
            cursor: pointer;
        }

        .content-input-primary .form-ptg-primary[type="time"]::-webkit-calendar-picker-indicator {
            background: url(https://5298967-sb1.app.netsuite.com/core/media/media.nl?id=109002&c=5298967_SB1&h=8T8_xbgLaXGq57So_VQ-KoCwOPoyvxXLL-O9cpcfxC44F6Do) center/80% no-repeat;
            cursor: pointer;
        }

        .form-search {
            width: 100%;
            position: relative;
        }

        .p-rel {
            position: relative;
        }

        .form-search .form-ptg {
            padding-left: 45px;
            padding-right: 45px;
        }
        

        .form-search .fa-magnifying-glass {
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            margin: auto;
            height: 20px;
            font-size: 20px;
            cursor: text;
        }

        .form-search .fa-xmark {
            position: absolute;
            right: 15px;
            top: 0;
            bottom: 0;
            margin: auto;
            height: 20px;
            font-size: 20px;
            cursor: pointer;
        }

        .vertical-center {
            margin: auto;
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            height: fit-content;
            width: fit-content;
        }

        label {
            margin: 0;
        }

        .fw-bold {
            font-weight: bold;
        }

        .content-tabs {
            background-color: rgb(225, 225, 225);
            ;
        }

        .content-tabs .tab {
            padding: 7px 20px;
            margin: 0px 0;
            cursor: pointer;
        }

        .tab.active {
            background: #ffffff;
            border-radius: 10px 0;
            color: #355da7;
        }

        .modal-header .modal-title {
            color: #ffffff;
        }

        .content-input label {
            color: #737373;
            margin-bottom: 5px;
            font-size: 16px;
            font-weight: bold;
        }

        .content-input-primary label {
            color: #355da7;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .color-primary {
            color: #355da7;
        }

        .ft-18 {
            font-size: 18px;
        }

        .invisible {
            visibility: hidden;
        }

        .ft-24 {
            font-size: 24px;
        }

        .table-gen {
            min-width: 100%;
        }

        .table-gen .sticky-col {
            position: -webkit-sticky;
            position: sticky;
            left: 0px;
        }

        .table-gen thead tr th {
            position: sticky;
            top: 0;
        }

        .table-gen thead tr th,
        .table-gen tbody tr td {
            padding-top: 10px;
            padding-bottom: 10px;
        }

        .table-gen-blue thead tr th {
            background: #355da7;
            color: #ffffff;
        }

        .table-gen-blue tbody tr:nth-of-type(odd) td {
            background-color: #ffffff;
        }

        .table-gen-blue tbody tr:nth-of-type(even) td {
            background-color: rgb(225, 225, 225);
        }

        .text-right {
            text-align: right;
        }

        .btn-expand {
            width: 60px;
            height: 60px;
            position: absolute;
            right: -30px;
            top: 0;
            bottom: 0;
            margin: auto;
        }

        .btn-expand-down {
            width: 60px;
            height: 60px;
            position: absolute;
            bottom: -30px;
            left: 0;
            right: 0;
            margin: auto;
        }

        .btn-expand .btn,
        .btn-expand-down .btn {
            width: 100%;
            height: 100%;
            background: #e7792b;
            border-radius: 100px;
            cursor: pointer;
            box-shadow: 5px 2px 20px 6px rgb(0 0 0);
            position: relative;
        }

        .btn-expand-down .btn {
            z-index: 2;
            position: relative;
        }

        .btn-expand .btn:hover,
        .btn-expand-down .btn:hover {
            background: #e98640;
        }

        .btn-expand .btn i {
            position: absolute;
            left: 0;
            right: 15px;
            bottom: 0;
            top: 0;
            margin: auto;
            height: 22px;
            font-size: 22px;
            color: #ffffff;
        }

        .btn-expand-down .btn i {
            position: absolute;
            left: 0;
            top: 5px;
            right: 0;
            left: 0;
            margin: auto;
            font-size: 22px;
            color: #ffffff;
        }

        .title-tab {
            font-size: 24px;
            font-weight: bold;
            color: #d4d4d4;
        }

        .title-tab.active {
            cursor: pointer;
            color: #000000;
        }

        .c-pointer {
            cursor: pointer;
        }

        .card {
            box-shadow: rgb(0 0 0 / 20%) 0px 3px 1px -2px, rgb(0 0 0 / 14%) 0px 2px 2px 0px, rgb(0 0 0 / 12%) 0px 1px 5px 0px;
        }

        .text-center {
            text-align: center;
        }

        .title-ptg {
            font-size: 24px;
        }

        .check-ptg {
            font-size: 20px;
        }

        /* no global ccs */
        #filters-data {
            background-color: rgb(225, 225, 225);
            position: relative;
        }
        #content-filters {
            background-color: rgb(225, 225, 225);
            height: 155px;
            overflow: auto;
            position: relative;
        }

        #content-casos {
            width: 100%;
            overflow: auto;
            background-color: white;
            height: calc(100vh - 312px);
            position: relative;
        }

        #content-casos.no-expand {
            height: calc(100vh - 157px);
        }

        #historic-data {
            overflow: auto;
            height: calc(100vh - 449px);
        }

        #content-forms {
            overflow: hidden;
            background-color: #ffffff;
        }

        .tabs-content {
            height: calc(100vh - 326px);
            overflow: auto;
            background-color: #ffffff;
            overflow-x: hidden;
        }

        .tabs-content.no-expand {
            height: calc(100vh - 122px);
        }

        #content-forms.no-expand .tabs-content {
            height: calc(100vh - 324px);
        }

        #content-avisos {
            height: calc(100vh - (100vh - 290px) - 56px);
        }

        .content-input .select2 {
            font-size: 16px;
            border: solid 2px #9d9b99;
            border-radius: 9px;
            padding-left: 9px;
            color: #737373;
            padding-bottom: 9px;
            padding: 2px 9px;
            background: white;
            width: 100% !important;
        }

        .content-input.content-input-primary .select2 {
            border: solid 2px #355da7;
            color: #355da7;
        }

        .content-input .select2 .select2-selection {
            border: 0;
        }

        .content-input .select2 .select2-selection .select2-selection__rendered {
            padding-left: 0;
        }

        .content-gen {
            border-radius: 20px;
            background-color: #efefef;
        }

        .content-gen .title {
            color: #000000;
            font-weight: bold;
        }

        .content-gen .resp {
            color: #000000;
            border-bottom: 1px solid #000000;
        }

        .dropdown-menu {
            width: 180px;
        }

        textarea {
            resize: none;
        }

        .border-bottom-primary {
            border-bottom: solid 2px #355da7;
        }

        input:disabled, textarea:disabled, select:disabled {
            background-color: #c9c9c9;
            cursor: not-allowed;
        }

        .tab {
            font-size: 20px;
            font-weight: bold;
            color: #ffffff;
            background-color:rgb(182, 182, 182);
            border: 2px solid rgb(182, 182, 182);
            padding-left: 15px;
            cursor: pointer;
        }

        .tab.active {
            cursor: unset;
            background-color: var(--color-primary);
        }

        .tab:first-child {
            border-radius: 10px 0 0 10px;
        }

        .tab:last-child {
            border-radius: 0 10px 10px 0;
        }

        #tablePedidos tfoot, #tableCasos tfoot {
            position: fixed;
            width: fit-content;
            margin: auto;
            left: 0;
            right: 0;
            bottom: 0;
        }
        #tablePedidos tfoot.expand, #tableCasos tfoot.expand {
            right: 50%;
        }

        tfoot .pag a {
            color: #000;
            background-color: #b0c1e0;
            border-color: #b0c1e0;
        }

        tfoot .pag a:hover {
            color: #000;
            background-color: #9eaeca;
            border-color: #9eaeca;
        }

        tfoot .pag a.active, tfoot .pag a.active:hover {
            color: #fff;
            background-color: #355da7;
            border-color: #355da7;
        }

        label.label-ptg {
            color: #355da7;
            margin-bottom: 5px;
            font-size: 16px;
            font-weight: bold;
        }

        .special-group{
            padding: 0!important;
        }

        .special-group > input:read-only {
            /* cursor: not-allowed; */
            background-color: white;
        }

        .special-group > .input-group-prepend {
            font-size: 16px!important;
            color: #355da7!important;
            margin-left: 1px!important;
        }

        .special-group > input {
            font-size: 16px;
            color: #355da7;
            margin-right: 1px;
            border-width:0px;
            border:none;
        }
        .special-group {
            font-size: 16px;
            border: solid 2px #9d9b99;
            border-radius: 9px;
            padding-left: 9px;
            color: #737373;
            padding-right: 9px;
            padding-top: 0;
            padding-bottom: 0;
            width: 100%;
            padding-top: 9px;
            padding-bottom: 9px;
        }

        .special-group {
            border: solid 2px #355da7;
            color: #355da7;
        }
    </style>
</head>

<body data-topbar="dark" data-spy="scroll" data-offset="175" style="overflow: hidden;">
    <header class="bg-primary-cc">
        <div class="row align-items-center w-100">
            <!--<div class="col-auto pr-0">
                <button id="btnMenu" type="button" class="btn bg-primary-cc btn-flat btn-header"><i
                        class="fa-solid fa-bars"></i></button>
                <button id="btnBack" type="button" class="btn bg-primary-cc btn-flat btn-header d-none"><i
                        class="fa-solid fa-arrow-left"></i></button>
            </div>-->
            <div class="col-auto pr-0">
                <img src="https://5298967-sb1.app.netsuite.com/core/media/media.nl?id=108998&c=5298967_SB1&h=58fXy2zvwjIT_OA9h721BFfwCFF1pYHerADEgGg1wbWxKFPt"
                    alt="" height="56">
            </div>
            <div id="header-title" class="col">
                Avisos y llamadas
            </div>
            <div class="col-auto p-0">
                <div class="row align-items-center">
                    <div class="col-auto pr-0 ft-16" id="today">
                    </div>
                    <div class="col-auto pr-0 ft-16">
                        <strong>ROL: </strong><span id="role"></span>
                    </div>
                    <div class="col-auto pr-0 ft-16">
                        <strong>PLANTA: </strong>
                    </div>
                    <div class="col-auto pr-0 ft-16">
                        <select id="plantas" type="date" style="
                            width: 190px; 
                            height: 30px; 
                            background: #ffffff; 
                            border-width: 1px; 
                            border-color: #808080; 
                            color: #000;">
                        </select>
                    </div>
                    <div class="col-auto">
                        <div class="chip bg-primary-cc">
                            <img
                                src="https://5298967-sb1.app.netsuite.com/core/media/media.nl?id=108996&c=5298967_SB1&h=64w8opEXTYUI8Zk4V_YCr91jyFiSRorKvI31OBBt0vD9Su8V">
                            <span class="user-name"></span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </header>

    <div id="formVerDetallesPedidos" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="titleerDetallesPedidosModal" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document" style="width: 600px;">
            <div class="modal-content " style="border: 0">
                <div class="modal-header">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <img src="https://5298967-sb1.app.netsuite.com/core/media/media.nl?id=110815&c=5298967_SB1&h=he-4rJolZ3J7WidhKv2oNWSuYY-s45IhArkF-ivqlvB7sd_A"
                            alt="" width="120">
                        </div>
                        <div class="col text-center">
                            <label class="fw-bold" style="font-size: 22px;" id="verDetallesCliente"></label><br>
                            <label class="fw-bold" style="font-size: 18px;" id="verDetallesTelefono"></label><br>
                            <label class="fw-bold" style="font-size: 16px;" id="verDetallesDireccion"></label><br>
                            <label class="fw-bold" style="font-size: 16px;">Tipo: <span id="verDetallesTipoServicio"></span></label>
                        </div>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="content-gen">
                        <div class="row p-3 align-items-end">
                          <div class="col-3 title">Servicio</div>
                          <div id="verDetallesServicio" class="col-9 resp"></div>
                        </div>
                        <div class="row p-3 align-items-end">
                          <div class="col-3 title">Fecha Prometida</div>
                          <div id="verDetallesFechaPrometida" class="col-9 resp"></div>
                        </div>
                        <div class="row p-3 align-items-end">
                          <div class="col-3 title">Tipo Producto</div>
                          <div id="verDetallesTipoProducto" class="col-9 resp"></div>
                        </div>
                        <div class="row p-3 align-items-end">
                            <div class="col-3 title">Estado de seguimiento</div>
                            <div id="verDetallesEstadoSeguimiento" class="col-9 resp"></div>
                        </div>
                        <div class="row p-3 align-items-start">
                            <div class="col-3 title">Observaciones</div>
                            <div id="verDetallesObservaciones" class="col-9 resp"></div>
                        </div>
                        <div class="row p-3">
                            <div class="col-12">
                                <div class="row">
                                    <div class="card-body p-0">
                                        <div class="col-12 d-none">
                                            <div class="table-responsive">
                                                <table class="table table-striped productosCilindroPedido m-0">
                                                    <thead style="color: #000;">
                                                        <tr>
                                                            <th scope="col">Producto</th>
                                                            <th scope="col" class="text-center">Cantidad</th>
                                                            <th scope="col" class="text-center">Capacidad</th>
                                                            <th scope="col" class="text-center">Valor</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                    </tbody>
                                                    <tfoot>
                                                        <tr>
                                                            <td colspan="3" style="text-align: right; font-weight: bold;">Total</td>
                                                            <td colspan="1" class="text-center total" data-total="">$0 mxn</td>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="col-12 d-none">
                                            <div class="table-responsive">
                                                <table class="table table-striped productosEstacionarioPedido">
                                                    <thead>
                                                        <tr>
                                                            <th scope="col">Producto</th>
                                                            <th scope="col" class="text-center">Litros</th>
                                                            <th scope="col" class="text-center">Cantidad</th>
                                                            <th scope="col" class="text-center">Total</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                    </tbody>
                                                    <tfoot>
                                                        <tr>
                                                            <td colspan="3" style="text-align: right; font-weight: bold;">Total</td>
                                                            <td colspan="1" class="text-center total" data-total="">$0 mxn</td>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="formConfirmarPedidos" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="titleerDetallesPedidosModal" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document" style="width: 50%;">
            <div class="modal-content " style="border: 0">
                <div class="modal-body" style="max-height: calc(100vh - 145px); overflow: auto;">
                    <div class="row align-items-center">
                        <div class="col"></div>
                        <div class="col-auto text-center">
                            <label class="fw-bold color-primary" style="font-size: 22px;" id="dataPedidosCliente"></label><br>
                            <label class="fw-bold color-primary" style="font-size: 18px;" id="dataPedidosTelefono"></label><br>
                            <label class="fw-bold color-primary" style="font-size: 16px;" id="dataPedidosDireccion"></label>
                        </div>
                        <div class="col"></div>
                    </div>
                    <div class="row pb-2">
                        <div class="col">
                            <label class="color-primary"><strong>No. Servicio: </strong><span id="noPedido"></span></label>
                        </div>
                        <div class="col-auto">
                            <label class="color-primary"><strong>Fecha solicitud: </strong><span id="fechaSolicitudPedido"></span></label>
                        </div>
                    </div>
                    <div class="row pb-2">
                        <div class="col-4">
                            <div class="content-input content-input-primary">
                                <label>Fecha prometida*</label>
                                <input id="fechaPrometidaPedido" type="date" class="form-ptg form-ptg-primary">
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="content-input content-input-primary">
                                <label>Desde*</label>
                                <input id="desdePedido" type="time" class="form-ptg form-ptg-primary">
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="content-input content-input-primary">
                                <label>Hasta*</label>
                                <input id="hastaPedido" type="time" class="form-ptg form-ptg-primary">
                            </div>
                        </div>
                    </div>
                    <div class="row pb-2">
                        <div class="col-4">
                        </div>  
                        <div class="col-4">
                            <div class="content-input content-input-primary">
                                <label>Zona de venta</label>
                                <input id="zonaVentaPedido" readonly type="text" class="form-ptg form-ptg-primary">
                            </div>
                        </div>
                    </div>
                    <div class="row pb-2 align-items-center">
                        <div class="col">
                            <label class="color-primary ft-18">Lista de pedido</label>
                        </div>
                        <div class="col-auto">
                            <button id="agregarProducto" type="button" class="btn bg-secondary-cc">
                                <i class="fa-solid fa-plus"></i> Agregar producto
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="card-body">
                            <div class="col-12 d-none">
                                <div class="table-responsive">
                                    <table class="table table-striped productosCilindroPedidoForm">
                                        <thead>
                                            <tr>
                                                <th scope="col">Producto</th>
                                                <th scope="col" class="text-center">Cantidad</th>
                                                <th scope="col" class="text-center">Capacidad</th>
                                                <th scope="col" class="text-center">Valor</th>
                                                <th scope="col" class="text-center">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="4" style="text-align: right; font-weight: bold;">Descuento</td>
                                                <td colspan="1" class="text-center descuento" data-descuento="">$0 mxn</td>
                                            </tr>
                                            <tr>
                                                <td colspan="4" style="text-align: right; font-weight: bold;">Total</td>
                                                <td colspan="1" class="text-center total" data-total="">$0 mxn</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            <div class="col-12 d-none">
                                <div class="table-responsive">
                                    <table class="table table-striped productosEstacionarioPedidoForm">
                                        <thead>
                                            <tr>
                                                <th scope="col">Producto</th>
                                                <th scope="col" class="text-center">Cantidad</th>
                                                <th scope="col" class="text-center">Litros</th>
                                                <th scope="col" class="text-center">Total</th>
                                                <th scope="col" class="text-center">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="4" style="text-align: right; font-weight: bold;">Descuento</td>
                                                <td colspan="1" class="text-center descuento" data-descuento="">$0 mxn</td>
                                            </tr>
                                            <tr>
                                                <td colspan="4" style="text-align: right; font-weight: bold;">Total</td>
                                                <td colspan="1" class="text-center total" data-total="">$0 mxn</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            <div class="col-12" id="sinProductos" style="position: relative; min-height: 90px;">
                                <div
                                    style="text-align: center; position: absolute; top: 0; bottom: 0; right: 0; left: 0; font-size: 15px; margin: auto; height: 25px;">
                                    <label class="color-primary">Sin productos en el pedido.</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row pb-2 align-items-center">
                        <div class="col">
                            <label class="color-primary ft-18">Lista de métodos de pago</label>
                        </div>
                        <div class="col-auto">
                            <button id="agregarMetodoPago" type="button" class="btn bg-secondary-cc">
                                <i class="fa-solid fa-plus"></i> Agregar método de pago
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="card-body">
                            <div class="col-12">
                                <div class="table-responsive">
                                    <table class="table table-striped productosMetodoPagoForm">
                                        <thead>
                                            <tr>
                                                <th scope="col">Método</th>
                                                <th scope="col" class="text-center">Folio</th>
                                                <th scope="col" class="text-center">Cantidad</th>
                                                <th scope="col" class="text-center">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="3" style="text-align: right; font-weight: bold;">Total</td>
                                                <td colspan="1" class="text-center total" data-total="">$0 mxn</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                            <div class="col-12" id="sinMetodosPago" style="position: relative; min-height: 90px;">
                                <div
                                    style="text-align: center; position: absolute; top: 0; bottom: 0; right: 0; left: 0; font-size: 15px; margin: auto; height: 25px;">
                                    <label class="color-primary">Sin métodos de pago registrados.</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row pb-2 align-items-center">
                        <div class="col-12">
                            <div class="content-input content-input-primary">
                                <label>Observaciones</label>
                                <textarea placeholder="Observaciones" id="observacionesPagoPedido" rows="3"
                                    class="form-ptg form-ptg-primary"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        aria-label="Close">Cancelar</button>
                    <button id="btnConfirmarPedido" type="button" class="btn btn-primary">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="formReprogramarModal" class="modal fade" tabindex="-1" role="dialog"
        aria-labelledby="titleReprogramarModal" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document" style="width: 300px;">
            <div class="modal-content " style="border: 0">
                <div class="modal-header bg-primary-cc">
                    <h5 class="modal-title" id="titleReprogramarModal">Reprogramar servicio: <span id="reprogramarPedido"></span></h5>
                </div>
                <div class="modal-body">
                    <div class="content-input content-input-primary">
                        <label>Fecha prometida*</label>
                        <input id="fechaPrometidaReprogramar" type="date" class="form-ptg form-ptg-primary">
                    </div>
                    <div class="content-input content-input-primary">
                        <label>Desde*</label>
                        <input id="desdeReprogramar" type="time" class="form-ptg form-ptg-primary">
                    </div>
                    <div class="content-input content-input-primary">
                        <label>Hasta*</label>
                        <input id="hastaReprogramar" type="time" class="form-ptg form-ptg-primary">
                    </div>
                    <div class="content-input content-input-primary mt-3">
                        <label>Comentario</label><br>
                        <textarea rows="3" id="comentarioReprogramar" class="form-ptg form-ptg-primary"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        aria-label="Close">Cancelar</button>
                    <button id="guardarReprogramar" type="button" class="btn btn-primary">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="formCambiarEstadoModal" class="modal fade" tabindex="-1" role="dialog"
        aria-labelledby="titleCambiarEstadoModal" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document" style="width: 400px;">
            <div class="modal-content " style="border: 0">
                <div class="modal-header bg-primary-cc">
                    <h5 class="modal-title" id="titleCambiarEstadoModal">Cambiar estado del servicio: <span id="cambiarEstadoPedido"></span></h5>
                </div>
                <div class="modal-body">
                    <div class="content-input content-input-primary">
                        <label>Estado*</label><br>
                        <select id="estadoCambiarEstado" class="form-ptg form-ptg-primary">
                        </select>
                    </div>
                    <div class="content-input content-input-primary mt-3">
                        <label>Motivo de Cancelacion*</label><br>
                        <select id="cambiarEstadoOppMotivo" class="form-ptg form-ptg-primary">
                        </select>
                    </div>
                    <div class="content-input content-input-primary mt-3">
                        <label>Observaciones*</label><br>
                        <textarea rows="3" id="cambiarEstadoOppObservaciones" class="form-ptg form-ptg-primary">
                        </textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        aria-label="Close">Cancelar</button>
                    <button id="guardarCambiarEstado" type="button" class="btn btn-primary">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="formSeguimientoModal" class="modal fade" tabindex="-1" role="dialog"
        aria-labelledby="titleSeguimientoModal" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document" style="width: 600px;">
            <div class="modal-content " style="border: 0">
                <div class="modal-header bg-primary-cc">
                    <h5 class="modal-title" id="titleSeguimientoModal">Seguimiento del servicio: <span id="seguimientoPedido"></span></h5>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12">
                            <label style="font-weight: bold;">Lista de comentarios</label><br>
                            <table class="table-gen table-gen-blue text-center" id="table-notas-seguimiento">
                                <thead>
                                    <tr>
                                        <th>Autor</th>
                                        <th>Fecha</th>
                                        <th>Contenido</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="content-input content-input-primary">
                                <div class="row">
                                    <div class="col">
                                        <label>Nueva nota*</label>
                                    </div>
                                </div>
                                <textarea id="nuevaNotaSeguimiento" rows="3" placeholder="Nota..." class="form-ptg form-ptg-primary"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        aria-label="Close">Cancelar</button>
                    <button id="guardarSeguimiento" type="button" class="btn btn-primary">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="formNotasAdicionalesModal" class="modal fade" tabindex="-1" role="dialog"
        aria-labelledby="titleNotasAdicionalesModal" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document" style="width: 300px;">
            <div class="modal-content " style="border: 0">
                <div class="modal-header bg-primary-cc">
                    <h5 class="modal-title" id="titleNotasAdicionalesModal">Agregar nota</h5>
                </div>
                <div class="modal-body">
                    <textarea id="notaAdicional" rows="3" placeholder="Nota..."
                        class="form-ptg form-ptg-primary"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        aria-label="Close">Cancelar</button>
                    <button id="guardarNotaAdicional" type="button" class="btn btn-primary">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="formProductosModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="titleProductoModal" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document" style="width: 700px;">
            <div class="modal-content " style="border: 0">
                <div class="modal-header bg-primary-cc">
                    <h5 class="modal-title" id="titleProductoModal">Agregar producto</h5>
                </div>
                <div class="modal-body">
                    <div class="row info-minimo-gas-lp d-none">
                        <div class="col-12">
                            <div class="alert alert-info" role="alert">
                                El monto mínimo a vender es de $<span class="minimo-gas-lp"></span> mxn.
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 d-none">
                            <div class="content-input content-input-primary">
                                <label>Articulo ID</label>
                                <input id="pedidoProductoId" type="text" class="form-ptg form-ptg-primary">
                            </div>
                        </div>
                    </div>
                    <div class="row pb-2">
                        <div class="col-6">
                            <div class="content-input content-input-primary">
                                <label>Producto</label>
                                <select id="productoFormProductos" class="form-ptg form-ptg-primary">
                                    <option value="">Seleccione una opción</option>
                                    <option value="cilindro" class="opt-pro-pedido-cilindro">Cilindro</option>
                                    <option value="estacionario" class="opt-pro-pedido-estacionario">Estacionario</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-6 cilindroFormProductos d-none">
                            <div class="content-input content-input-primary">
                                <label>Envase</label>
                                <input id="envaseFormProductos" type="checkbox" class="form-ptg form-ptg-primary">
                            </div>
                        </div>
                    </div>
                    <div class="row pb-2 cilindroFormProductos d-none">
                        <div class="col-6">
                            <div class="content-input content-input-primary">
                                <label>Capacidad</label>
                                <select id="capacidadFormProductos" class="form-ptg form-ptg-primary">
                                </select>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="content-input content-input-primary">
                                <label>Cantidad</label>
                                <input id="cantidadFormProductos" type="number" min="1" class="form-ptg form-ptg-primary">
                            </div>
                        </div>
                    </div>
                    <div class="row pb-2 estacionarioFormProductos d-none">
                        <div class="col-6">
                            <div class="content-input content-input-primary">
                                <label>Litros</label>
                                <input id="litrosFormProductos" type="number" min="1" class="form-ptg form-ptg-primary">
                            </div>
                        </div>
                    </div>
                    <div class="row pb-2">
                        <div class="col-6">
                            <div class="content-input content-input-primary">
                                <label>Valor</label>
                                <input id="valorFormProductos" type="number" readonly class="form-ptg form-ptg-primary">
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="label-ptg">Total</label>
                            <div class="input-group special-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="basic-addon1" style="border: none; height: 42px; font-size: 16px; color: #355da7; margin-left: 1px; background-color: white;">$</span>
                                </div>
                                <input id="totalFormProductos" type="number" class="form-control" placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">
                            </div>
                            <!-- <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">$</span>
                                </div>
                                <input id="totalFormProductos" type="number" readonly aria-label="Amount (to the nearest dollar)" class="form-ptg form-ptg-primary">
                                <div class="input-group-append">
                                    <span class="input-group-text">.00</span>
                                </div>
                            </div> -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close">Cancelar</button>
                    <button id="guardarProductosForm" type="button" class="btn btn-primary">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="formMetodoPagosModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="titleMetodoPagosModal" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered" role="document" style="width: 400px;">
            <div class="modal-content " style="border: 0">
                <div class="modal-header bg-primary-cc">
                    <h5 class="modal-title" id="titleMetodoPagosModal">Agregar método de pago</h5>
                </div>
                <div class="modal-body">
                    <div class="row pb-2">
                        <div class="col-12 pb-2">
                            <div class="content-input content-input-primary">
                                <label>Método de pago</label>
                                <select id="metodoPagoPedido" class="form-ptg form-ptg-primary">
                                    <option value="">Seleccione una opción</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-12 pb-2">
                            <div class="content-input content-input-primary">
                                <label>Monto a pagar</label>
                                <input id="montoPagoPedido" oninput="onlyNumbers(this.value, '#montoPagoPedido')" class="form-ptg form-ptg-primary"> </select>
                            </div>
                        </div>
                        <div class="col-12 pb-2 d-none">
                            <div class="content-input content-input-primary">
                                <label>Folio de autorización</label>
                                <input id="folioAutorizacionPedido" class="form-ptg form-ptg-primary"> </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close">Cancelar</button>
                    <button id="guardarMetodoPagoForm" type="button" class="btn btn-primary">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="home-view" class="w-100 m-0">
        <div id="filters-data" class="p-3">
            <div class="btn-expand-down">
                <div class="p-rel btn">
                    <i class="fa-solid fa-caret-up"></i>
                </div>
            </div>
            <div id="content-filters" class="row">
                <div class="col-auto pb-2 ">
                    <div class="content-input" style="min-width: 280px;">
                        <label>Ruta</label><br>
                        <select id="filterRuta" onchange="getServicios(this)" class="form-ptg">
                            
                        </select>
                    </div>
                </div>
                <div class="col-auto pb-2 ">
                    <div class="content-input" style="min-width: 300px;">
                        <label>Colonia</label><br>
                        <select id="filterZona" onchange="getServicios(this)" class="form-ptg">
                            
                        </select>
                    </div>
                </div>
                <div class="col-auto pb-2 ">
                    <div class="content-input">
                        <label>Tipo seguimiento</label><br>
                        <select id="filterTipoSeguimiento" onchange="getServicios(this)" class="form-ptg">
                            <option value="1">Aviso</option>
                            <option value="2">Teléfonico</option>
                        </select>
                    </div>
                </div>
                <div class="col-auto pb-2 ">
                    <div class="content-input">
                        <label>Tipo de Producto</label><br>
                        <select id="filterTipoProducto" onchange="setSelectRutas(true);" class="form-ptg" style="width: 180px;">
                        </select>
                    </div>
                </div>    
                <div class="col-auto pb-2 ">
                    <div class="content-input">
                        <label>Estado de seguimiento</label><br>
                        <select id="filterEstadoSeguimiento" onchange="getServicios(this);" class="form-ptg" style="width: 180px;">
                        </select>
                    </div>
                </div> 
                <!--<div class="col-auto pb-2 ">
                    <div class="content-input">
                        <label>Próxima llamada</label><br>
                        <input id="filterProximaLlamada" onchange="getServicios(this)" type="date" class="form-ptg"/>
                    </div>
                </div>-->
            </div>
        </div>
        <div id="content-data">
            <div class="row m-0" style="width: 100vw;">
                <div class="col-12 p-0" style="z-index: 2; position: relative; height: fit-content;">
                    <div id="content-casos">     
                        <table id="tablePedidos" class="table-gen table-gen-blue tipo-pedido">
                            <thead>
                                <tr>
                                    <th style="min-width: 40px; z-index: 1; left: 0;" class="text-center sticky-col">
                                        <i class="fa-solid fa-arrow-rotate-right c-pointer" onclick="getServicios(this)"></i>
                                        <div style="position: absolute; right: 0; top: 0; height: 100%; width: 1px; background-color: #000;"></div>
                                    </th>
                                    <th style="min-width: 40px; z-index: 1; left: 40;" class="text-center sticky-col">
                                        <div style="position: absolute; right: 0; top: 0; height: 100%; width: 1px; background-color: #000;"></div>
                                    </th>
                                    <th style="min-width: 110px" class="text-center">No. Servicio</th>
                                    <th style="min-width: 95px" class="text-center">Id Cliente</th>
                                    <th style="min-width: 135px" class="text-center">Tipo seguimiento</th>
                                    <th style="min-width: 155px" class="text-center">Fecha Prometida</th>
                                    <th style="min-width: 130px" class="text-center">Estado</th>
                                    <th style="min-width: 265px" class="text-center">Nombre Cliente</th>
                                    <th style="min-width: 125px" class="text-center">Teléfono</th>
                                    <th style="min-width: 125px" class="text-center">Tipo de producto</th>
                                    <th style="min-width: 355px" class="text-center">Dirección</th>
                                    <th style="min-width: 300px" class="text-center">Observaciones</th>
                                </tr>
                            </thead>
                            <tbody>   
                                <tr>
                                    <td colspan="17" class="text-center fw-bold py-5">Sin pedidos encontrados</td>
                                </tr>                  
                            </tbody>
                        </table>
                    </div>  
                </div>
            </div>
        </div>
    </div>

    <!-- END layout-wrapper -->

    <!-- JAVASCRIPT -->
    <script src="https://themesbrand.com/skote/layouts/assets/libs/jquery/jquery.min.js"></script>
    <script src="https://themesbrand.com/skote/layouts/assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- <script src="assets/libs/simplebar/simplebar.min.js"></script> -->
    <!-- <script src="assets/libs/jquery.easing/jquery.easing.min.js"></script> -->

    <!-- Datatablets -->
    <script src="https://themesbrand.com/skote/layouts/assets/libs/datatables.net/js/jquery.dataTables.min.js"></script>
    <script
        src="https://themesbrand.com/skote/layouts/assets/libs/datatables.net-bs4/js/dataTables.bootstrap4.min.js"></script>

    <!-- Datepicker -->
    <script
        src="https://themesbrand.com/skote/layouts/assets/libs/bootstrap-datepicker/js/bootstrap-datepicker.min.js"></script>
    <script src="https://themesbrand.com/skote/layouts/assets/libs/@chenfengyuan/datepicker/datepicker.min.js"></script>

    <!-- Timepicker -->
    <script
        src="https://themesbrand.com/skote/layouts/assets/libs/bootstrap-timepicker/js/bootstrap-timepicker.min.js"></script>
    <!-- Select2 -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script
        src="https://themesbrand.com/skote/layouts/assets/libs/bootstrap-timepicker/js/bootstrap-timepicker.min.js"></script>
    <!-- Extra -->
    <script src="https://themesbrand.com/skote/layouts/assets/libs/metismenu/metisMenu.min.js"></script>
    <!-- <script src="https://themesbrand.com/skote/layouts/assets/libs/simplebar/simplebar.min.js"></script> -->
    <script src="https://themesbrand.com/skote/layouts/assets/libs/node-waves/waves.min.js"></script>

    <!-- <script src="assets/js/app.js"></script> -->
    <script src="https://themesbrand.com/skote/layouts/assets/js/app.js"></script>

    <!-- Sweet alert -->
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <!-- Moment js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
        integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- FancyTable -->
    <script src="https://cdn.jsdelivr.net/npm/jquery.fancytable/dist/fancyTable.min.js"></script>

    <!-- Funciones generales -->
    <script type="text/javascript">
        userName = '${ds.userName}';
        userRole = '${ds.userRole}';
        urlPlantas = '${ds.getPlantas}';
        urlRutas = '${ds.getListRoutes}';
        urlStatusOp = '${ds.getListStatusOpp}';
        urlTiposServicios = '${ds.getListTypeServices}';
        urlGetZone = '${ds.getZone}';
        urlGetListTypeContact = '${ds.getListTypeContact}';
        urlGetOpp = '${ds.getOppMonitor}';
        urlGetItemsOpp = '${ds.getItemsOpp}';
        urPutOppMonitor = '${ds.putOppMonitor}';
        urlPostNoteandMessage = "${ds.postNoteandMessage}";
        urlGetMessageandNotes = '${ds.getMessageandNotes}';
        urlGetNotesOfOPP = '${ds.getNotesOfOPP}';
        urlGetListCancellReason = "${ds.getListCancellReason}";
        urlGetMethodPayments = '${ds.getMethodPayments}';
        urlObtenerArticulos = '${ds.getItems}';
        urlGetListStatusCallAlert = '${ds.getListStatusCallAlert}';
        statusOP = [];
        countServices = 0;
        metodoMultiple = 7;
        articuloGasLp = "4088";
        defDescuentoID = "4528";
        methodPayments = [];
        articulosArr = [];
        concatObsPagos = ["2", "8"];
        vrStatusAvisos = [];
        idDefPorContestar = 3;

        function getArticulos() {
            let settings = {
                url      : urlObtenerArticulos,
                method   : 'GET',
            }

            setAjax(settings).then((response) => {
                if ( response.data.length ) {
                    articulosArr = response.data;
                    $('#capacidadFormProductos').children('option').remove();
                    response.data.forEach(element => {
                        let articulo = '<option value='+element.id+' data-articulo=' + "'" + JSON.stringify(element) + "'" + '>'+element.nombre+'</option>';
                        if ( element.tipo_articulo == 1 ) {// Cilindro                            
                            $("#capacidadFormProductos").append( articulo );
                        }
                    });
                }
                readyInit();
            }).catch((error) => {
                readyInit();
                console.log(error);
            });
        }

        function getStatusCallAlert() {
            let settings = {
                url      : urlGetListStatusCallAlert,
                method   : 'GET',
            }

            setAjax(settings).then((response) => {
                if ( response.data.length ) {
                    vrStatusAvisos = [];
                    $('#filterEstadoSeguimiento').children('option').remove();
                    response.data.forEach(element => {
                        element.id = parseInt(element.id);                        
                    });
                    response.data.sort(dynamicSort("id"));
                    response.data.forEach(element => {
                        vrStatusAvisos.push(element);
                        $("#filterEstadoSeguimiento").append( '<option '+(element.id == idDefPorContestar ? 'selected' : '')+' value='+element.id+'>'+element.name+'</option>' );
                    });
                    
                }
                readyInit();
            }).catch((error) => {
                readyInit();
                console.log(error);
            });
        }

        // Se inyecta la información del usuario logueado
        $('.user-name').text(userName);
        $('#role').text(userRole);
        //$("#filterProximaLlamada").val(dateFormatFromDate(new Date(), "2"));

        $('body').delegate('.dropdown-toggle', 'show.bs.dropdown', function () {
            $(this).closest("td").css("z-index", "2");
        });

        $('body').delegate('.dropdown-toggle', 'hidden.bs.dropdown', function () {
            $(this).closest("td").css("z-index", "1");
        });

        // Limpia los campos del modal método de pago
        $('body').delegate('div#formMetodoPagosModal', 'hidden.bs.modal', function () {
            $(this).find('.form-ptg').val('');
            $(this).find('select.form-ptg').each(function( index ) {
                $( this ).val($(this).children("option:first").val());
            });
            $('#folioAutorizacionPedido').parent().parent().addClass('d-none');
        });

        // Abre el modal de métodos de pago
        $("#agregarMetodoPago").click(function () {
            let totalProducto = 0;
            let totalMetodosPago = 0;
            let montoRestante = 0;
            // Calcula el total del pedido basándose en los productos agregados al listado
            if (! $('.productosEstacionarioPedidoForm').parent().parent().hasClass('d-none') ) {// Estacionario
                totalProducto = $('.productosEstacionarioPedidoForm').children('tfoot').find('td.total').data('total');
            } else if (! $('.productosCilindroPedidoForm').parent().parent().hasClass('d-none') ) {// Cilindro
                totalProducto = $('.productosCilindroPedidoForm').children('tfoot').find('td.total').data('total');
            }

            // Calcula el total de método de pago basándose en los especificados en la lista
            if (! $('.productosMetodoPagoForm').parent().parent().hasClass('d-none') ) {// Contiene métodos
                totalMetodosPago = $('.productosMetodoPagoForm').children('tfoot').find('td.total').data('total');
            }

            montoRestante = parseFloat( Number(totalProducto) - Number(totalMetodosPago) ).toFixed(2);
            montoRestante = montoRestante > 0 ? montoRestante : 0;

            $('#montoPagoPedido').val(montoRestante);

            $('#formMetodoPagosModal').modal('show');
        });

        // Call a global ajax method
        function setAjax(settings) {
            // Generamos el AJAX dinamico para las peticiones relacionadas con peddos
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: settings.url,
                    method: settings.method,
                    data: settings.data ?? null,
                    // data: JSON.stringify(data),
                    contentType: 'application/json',
                    dataType: 'json',
                    success: function (response) {
                        if ( response.success ) {
                            resolve(response);
                        } else {
                            reject(response);
                            swal.close();
                            msg = response.msg ? response.msg : 'La petición no devolvió datos';
                            console.log('info', msg);
                            // infoMsg('info', msg);
                        }
                    }, error: function (xhr, status, error) {
                        console.error('mensaje de error');
                        reject({ xhr: xhr, status: status, error: error });
                    }
                });
            });
        }

        function dynamicSort(property) {
            var sortOrder = 1;
            if (property[0] === "-") {
                sortOrder = -1;
                property = property.substr(1);
            }
            return function (a, b) {
                /* next line works with strings and numbers, 
                * and you may want to customize it to your needs
                */
                var result = (a[property] < b[property]) ? -1 : (a[property] > b[property]) ? 1 : 0;
                return result * sortOrder;
            }
        }

        function dateFormatFromDate(date, format = "1") {
            if (typeof date == "string") {
                let aux = date;
                if(aux.split("-").length > 1) {
                    date = new Date(parseInt(aux.split("-")[0]), parseInt(aux.split("-")[1]) - 1, parseInt(aux.split("-")[2]));
                } else {
                    date = new Date(parseInt(aux.split("/")[2]), parseInt(aux.split("/")[1]) - 1, parseInt(aux.split("/")[0]));
                }                
            }

            let day = date.getDate();
            let month = date.getMonth();
            let year = date.getFullYear();
            let fecha = "";
            let months = ["Enero", "Febrero", "Marzo", "Abrrl", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            if (format == "1") {
                fecha = day + " de " + months[month] + " - " + timeFormatFromDate(date);
            } else if (format == "2") {
                if (day < 10) {
                    day = "0" + day;
                }
                month = month + 1;
                if (month < 10) {
                    month = "0" + month;
                }
                fecha = year + "-" + month + "-" + day;
            } else if (format == "3") {
                fecha = day + "/" + month + "/" + year + " " + timeFormatFromDate(date);
            } else if (format == "4") {
                if (day < 10) {
                    day = "0" + day;
                }
                month = month + 1;
                if (month < 10) {
                    month = "0" + month;
                }
                fecha = year + "-" + month + "-" + day + "T" + timeFormatFromDate(date, "2");
            } else if (format == "5") {
                if (day < 10) {
                    day = "0" + day;
                }
                month = month + 1;
                if (month < 10) {
                    month = "0" + month;
                }
                fecha = day + "/" + month + "/" + year;
            } else if (format == "6") {
                if (day < 10) {
                    day = "0" + day;
                }
                month = month + 1;
                if (month < 10) {
                    month = "0" + month;
                }
                fecha = day + "-" + month + "-" + year;
            } else if (format == "7") {
                if (day < 10) {
                    day = "0" + day;
                }
                month = month + 1;
                if (month < 10) {
                    month = "0" + month;
                }
                fecha = day + "/" + month + "/" + year + " " + timeFormatFromDate(date);;
            }

            return fecha;
        }

        function timeFormatFromDate(date, format = "1") {
            date = new Date(date);
            let hours = date.getHours();
            let minutes = date.getMinutes();
            let seconds = date.getSeconds();
            let period = hours < 12 ? 'a.m.' : 'p.m.';
            if (minutes < 10) {
                minutes = "0" + minutes;
            }
            if (seconds < 10) {
                seconds = "0" + seconds;
            }
            let hora = "";
            if (format == "1") {
                hours = (hours + 24) % 12 || 12;
                if (hours < 10) {
                    hours = "0" + hours;
                }

                hora = hours + ":" + minutes + " " + period;
            } else if (format == "2") {
                if (hours < 10) {
                    hours = "0" + hours;
                }

                hora = hours + ":" + minutes;
            } else if (format == "3") {
                if (hours < 10) {
                    hours = "0" + hours;
                }

                hora = hours + ":" + minutes + ":" + seconds;
            }
            return hora;
        }

        function loadMsg(msg = 'Espere un momento porfavor...') {
    
            let swalObj = {
                title: msg,
                buttons: false,
                closeOnEsc: false,
                closeOnClickOutside: false,
                content: {
                    element: "div",
                    attributes: {
                        innerHTML:"<i class='fa-solid fa-spinner fa-spin fa-2x'></i>"
                    },
                }
            };

            swal(swalObj).catch(swal.noop);

        }

        // Función para obtener los motivos de cancelar pedido
        function getListCancellReason() {
            let dataListCancellReason = {
                "requestType" : 'getListCancellReason'
            };

            let settings = {
                url      : urlGetListCancellReason,
                method   : 'GET',
                data     : JSON.stringify(dataListCancellReason),
            }

            setAjax(settings).then((response) => {
                if ( response.data.length ) {
                    $('#cambiarEstadoOppMotivo').children('option').remove();
                    response.data.forEach(element => {
                        $("#cambiarEstadoOppMotivo").append(
                            '<option value='+element.id+'>'+element.name+'</option>'
                        );
                    });
                }
                $('#cambiarEstadoOppMotivo').select2({
                    selectOnClose: true,
                    placeholder: "Seleccione un motivo",
                    dropdownParent: $('#formCambiarEstadoModal'),
                    language: {
                        "noResults": function(){
                            return "Sin resultados encontrados";
                        }
                    }
                });
                readyInit();
            }).catch((error) => {
                console.log(error);
            });
        }

        function getZonas() {
            let dataZonas = {
                "requestType" : 'getZonas'
            };

            let settings = {
                url      : urlGetZone,
                method   : 'GET',
                data     : JSON.stringify(dataZonas),
            }

            $('#filterZona').children('option').remove();
            $("#filterZona").append(
                '<option value="0">Todas</option>'
            );
            setAjax(settings).then((response) => {
                
                if (response.success && response.data.length ) {
                    for ( var key in response.data ) {
                        if ( response.data.hasOwnProperty( key )) {
                            $("#filterZona").append(
                                '<option value="'+response.data[key].id+'">'+response.data[key].nombre+'</option>'
                            );
                        }
                    }
                    readyInit();
                } else {
                    console.warn('No hay zonas por cargar');
                    readyInit();
                }
                $('#filterZona').select2({
                    selectOnClose: true,
                    placeholder: "Seleccione una zona",
                    language: {
                        "noResults": function(){
                            return "Sin resultados encontrados";
                        }
                    }
                });
            }).catch((error) => {
                $('#filterZona').select2({
                    selectOnClose: true,
                    placeholder: "Seleccione una zona",
                    language: {
                        "noResults": function(){
                            return "Sin resultados encontrados";
                        }
                    }
                });
                console.log(error);
                readyInit();
            });
        }

        // Función para obtener las plantas
        function getPlantas() {
            let dataPlantas = {
                "requestType" : 'getPlantas'
            };

            let settings = {
                url      : urlPlantas,
                method   : 'GET',
                data     : JSON.stringify(dataPlantas),
            }

            setAjax(settings).then((response) => {
                setSelectPlants((response.data));
            }).catch((error) => {
                console.log(error);
            });
        }

        // Método para llenar el select de plantas
        function setSelectPlants(items) {
            if ( items.length ) {
                $('select#plantas').children('option').remove();
                for ( var key in items ) {
                    if ( items.hasOwnProperty( key ) ) {
                        $("select#plantas").append(
                            '<option data-pedido-minimo="'+parseFloat(items[key].min).toFixed(2)+'" value='+items[key].id+'>'+items[key].nombre+'</option>'
                        );
                    }
                }
                getRutas();
            } else {
                console.warn('No hay plantas por cargar');
            }
        }

        function getStatusOportunidad() {
            let settings = {
                url      : urlStatusOp,
                method   : 'GET'
            }

            setAjax(settings).then((response) => {
                setSelectStatusOp((response.data));
            }).catch((error) => {
                console.log(error);
            });
        }

        $("#notasAdicionalesSeguimiento").click(function () {
            $("#formNotasAdicionalesModal").modal("show");
            $("#notaAdicional").val("");
        });

        $("#guardarSeguimiento").click(function() {
            let pedido = $("#formSeguimientoModal").data("item");
            if($("#nuevaNotaSeguimiento").val() && $("#nuevaNotaSeguimiento").val().trim()) {
                confirmMsg("warning", "¿Seguro que desea guardar el seguimiento?", function(resp) {
                    if(resp) {
                        loadMsg();
                        let nota = [{ 
                            type: "nota", 
                            idRelacionado: pedido.no_pedido, 
                            titulo: "Nota - Avisos y llamadas (seguimiento)", 
                            nota: $("#nuevaNotaSeguimiento").val().trim(),
                            transaccion: "oportunidad"
                        }];
                        let settings2 = {
                            url      : urlPostNoteandMessage,
                            method   : 'POST',
                            data: JSON.stringify({ informacion: nota })
                        }
                        setAjax(settings2).then((response) => {
                            if(response.success) {
                                swal.close();
                                infoMsg('success', '', "Seguimiento guardado de manera correcta", null, function(resp) {
                                    $("#formSeguimientoModal").modal('hide');
                                    getServicios();
                                }); 
                            } else {
                                infoMsg('error', 'Error:', "Ocurrio un error al tratar de guardar el seguimiento");
                                swal.close();
                            }
                        }).catch((error) => {
                            infoMsg('error', 'Error:', "Ocurrio un error al tratar de guardar el seguimiento");
                            swal.close();
                        });
                    }
                });
            } else {
                let aux = "<ul>";
                if(!$("#nuevaNotaSeguimiento").val() || !$("#nuevaNotaSeguimiento").val().trim()) {
                    aux += "<li>Nueva nota</li>";
                }
                aux += "</ul>";
                infoMsg('warning', 'Campos requeridos:', aux);
            }
        });

        vrStatus = [];
        idPorNotificar = "";
        idAsignado = "";
        idCancelado = "";
        idEntregado = "";
        idPorReprogramar = "";
        idPorConfirmar = "";
        // Método para llenar el select de los estado de la oportunidad
        function setSelectStatusOp(items) {
            vrStatus = [];
            if ( items.length ) {
                $('#estadoCambiarEstado').children('option').remove();
                items.forEach(element => {
                    if(element.nombre.trim().toLowerCase() == "por notificar") {
                        idPorNotificar = element.id;
                    }
                    if(element.nombre.trim().toLowerCase() == "asignado") {
                        idAsignado = element.id;
                    }
                    if(element.nombre.trim().toLowerCase() == "cancelado") {
                        idCancelado = element.id;
                    }
                    if(element.nombre.trim().toLowerCase() == "entregado") {
                        idEntregado = element.id;
                    }
                    if(element.nombre.trim().toLowerCase() == "por reprogramar") {
                        idPorReprogramar = element.id;
                    }
                    if(element.nombre.trim().toLowerCase() == "por confirmar") {
                        idPorConfirmar = element.id;
                    }
                    vrStatus.push(element);
                });
                vrStatus.forEach(element => {
                    if ( element.id != "2" && element.id != "3" && element.id != "6") {
                        $("#estadoCambiarEstado").append(
                            '<option value="'+element.id+'">'+element.nombre+'</option>'
                        );
                    }
                });
                $('#estadoCambiarEstado').select2({
                    selectOnClose: true,
                    placeholder: "Seleccione un estado",
                    dropdownParent: $('#formCambiarEstadoModal'),
                    language: {
                        "noResults": function(){
                            return "Sin resultados encontrados";
                        }
                    }
                });
                readyInit();
            } else {
                console.warn('No hay estados de solicitud por cargar');
                readyInit();
            }
        }

        $("#metodoPagoPedido").change(function () {
            let metodoId = $(this).val();
            if ( ["8", "2"].includes( metodoId ) ) {// Si el método de pago es transferencia, prepago, tarjeta de crédito, tarjeta de débito
                $("#folioAutorizacionPedido").parent().parent().removeClass("d-none");
            } else {
                $("#folioAutorizacionPedido").parent().parent().addClass("d-none");
            }
        });

        function getRutas(getPedidos = false) {
            if(getPedidos) {
                loadMsg();
            }
            let settings = {
                url      : urlRutas,
                method   : 'POST',
                data: JSON.stringify({
                    namePlanta : $("#plantas option:selected").text()
                })
            }

            setAjax(settings).then((response) => {
                if(response.success) {
                    rutasCilindros = response.rutaCilindro;
                    rutasEstacionarios = response.rutaEstacionario;
                    setSelectRutas(getPedidos);
                }        
            }).catch((error) => {
                console.log(error);
            });
        }

        $(".btn-expand-down").click(function () {
            if ($(this).find("i").hasClass('fa-caret-down')) {
                $(this).find(".btn").html('<i class="fa-solid fa-caret-up"></i>');
                $("#content-filters").removeClass("d-none");
                $("#content-casos").removeClass("no-expand");
                $(".tabs-content").removeClass("no-expand");
            } else {
                $(this).find(".btn").html('<i class="fa-solid fa-caret-down"></i>');
                $("#content-filters").addClass("d-none");
                $("#content-casos").addClass("no-expand");
                $(".tabs-content").addClass("no-expand");
            }
        });

        // Edita un producto agregado en la lista del pedido
        $('body').delegate('.edit-producto-cil, .edit-producto-est','click', function() {
            let button   = $(this);
            let prices   = $("#formConfirmarPedidos").data("item").precioZona;
            let artObj   = button.parent().parent().data('item');
            let total    = 0;
            let subtotal = 0;
            // let direccion = $('select#direccionCliente').children('option:selected').data('address');
            
            if ( button.hasClass('edit-producto-cil') ) {// Producto cilindro

                $("#productoFormProductos").val("cilindro");
                $("#totalFormProductos").prop('readonly', true);
                $(".cilindroFormProductos").removeClass("d-none");
                $(".estacionarioFormProductos").addClass("d-none");

                subtotal = parseFloat( Number(artObj.capacity) *  Number(artObj.quantity) * Number(prices)).toFixed(2);
                total    = parseFloat( Number(subtotal) * 1.16 ).toFixed(2);

                $('#capacidadFormProductos, #pedidoProductoId').val(artObj.article);
                $('#cantidadFormProductos').val(artObj.quantity);
                $('#valorFormProductos').val(subtotal);
                $('#totalFormProductos').val(total);

            } else if ( button.hasClass('edit-producto-est') ) {// Producto estacionario
                console.log(artObj);
                $("#productoFormProductos").val("estacionario");
                $("#totalFormProductos").attr('readonly', false);
                $(".estacionarioFormProductos").removeClass("d-none");
                $(".cilindroFormProductos").addClass("d-none");

                subtotal = parseFloat( Number(artObj.capacity) * Number(prices) ).toFixed(2);
                total    = parseFloat( Number(subtotal) * 1.16 ).toFixed(2);

                $("#pedidoProductoId").val( artObj.article );// Este input indicará que se trata de un edit
                $("#litrosFormProductos").val( artObj.capacity );
                $("#valorFormProductos").val( subtotal );
                $("#totalFormProductos").val( total );
            
            }

            // Se validan los option disponibles si es que algún producto ya fue registrado
            if (! $('table.productosEstacionarioPedidoForm').parent().parent().hasClass('d-none') ) {// Ya se agregó gas LP
                $(".opt-pro-pedido-cilindro").attr("disabled", true);
            } else if (! $('table.productosCilindroPedidoForm').parent().parent().hasClass('d-none') ) {// Ya se agregó un cilindro
                $(".opt-pro-pedido-estacionario").attr("disabled", true);
            } else {
                // $(".opt-pro-pedido-cilindro, .opt-pro-pedido-estacionario").attr("disabled", false);
            }

            $('#formProductosModal').modal('show');
        });

        $('body').delegate('#guardarProductosForm','click', function() {
            let tipoProducto = $('#productoFormProductos').val();
            let canContinue = false;
            let productoId  = $('#pedidoProductoId').val();
            let defaultProMsg = $('#sinProductos');
            let prices = $('#zonaPrecioCliente').text().replace('$', '');

            if ( tipoProducto == 'cilindro' ) {
                if( !$("#capacidadFormProductos").val() || $("#cantidadFormProductos").val() <= 0  || $("#valorFormProductos").val() <= 0 || $("#totalFormProductos").val() <= 0 ) {
                    canContinue = false;
                } else {
                    canContinue = true;
                }
            } else if ( tipoProducto == 'estacionario' ) {
                if( $("#litrosFormProductos").val() <= 0 || $("#valorFormProductos").val() <= 0  || $("#totalFormProductos").val() <= 0) {
                    canContinue = false;
                } else {
                    canContinue = true;
                }
            }

            if (! canContinue ) {
                alert("Favor de llenar todos los campos con *");
                return;
            }
            // Se remueve el mensaje principal de que no hay productos
            defaultProMsg.addClass('d-none');

            let itemId   = ( tipoProducto == 'cilindro' ? $( '#capacidadFormProductos' ).val() : articuloGasLp );
            let searchTr = $('tr[data-item-id="'+itemId+'"]');

            // Se agrega el artículo a la tabla
            if ( tipoProducto == 'cilindro' ) {// Cilindro

                $('.productosCilindroPedidoForm').parent().parent().removeClass('d-none');
                
                let total     = parseFloat($('#totalFormProductos').val()).toFixed(2);
                let artSel    = $( '#capacidadFormProductos' ).children('option:selected').data('articulo');
                let capacidad = parseInt( ( artSel && artSel.capacidad_litros ? artSel.capacidad_litros : 0 ) );
                let envase    = $('#envaseFormProductos').is(':checked');
                let articulo  = {
                    "zoneprice" : prices,// Este es el valor de la zona
                    "tipo"      : 1,
                    "capacity"  : capacidad,
                    "quantity"  : $( '#cantidadFormProductos' ).val(),
                    "article"   : $( '#capacidadFormProductos' ).val()
                };

                agregarEnvase(envase, $(".productosCilindroPedidoForm"), artSel, prices);
                
                if ( searchTr.length ) {// Se verifica si el artículo fue previamente registrado

                    if ( productoId ) {// Si es una edición, se reemplazará todo el contenido
                        searchTr.data('item', articulo);
                        // searchTr.data('item-id', articulo.article);
                        searchTr.children('td').siblings("td:nth-child(1)").text(artSel && artSel.nombre ? artSel.nombre : 'Sin nombre asignado');
                        searchTr.children('td').siblings("td:nth-child(2)").text(articulo['quantity']);
                        searchTr.children('td').siblings("td:nth-child(3)").text(capacidad+' kg');
                        searchTr.children('td').siblings("td:nth-child(4)").data('total', total);
                        searchTr.children('td').siblings("td:nth-child(4)").text('$'+total+' mxn');
                        // searchTr.children('td').siblings("td:nth-child(4)").children('button.delete-producto-cil').data('item-id', articulo.article);
                    } else {
                        let firstItem         = searchTr.data('item');
                        let firstTotal        = parseFloat( searchTr.children('td').siblings("td:nth-child(4)").data('total') ).toFixed(2);
                        firstItem['quantity'] = parseInt( Number(firstItem['quantity']) + Number(articulo['quantity']));
        
                        total = parseFloat(Number(total) + Number(firstTotal)).toFixed(2);
                        searchTr.data('item', firstItem);
                        searchTr.children('td').siblings("td:nth-child(2)").text(firstItem['quantity']);
                        searchTr.children('td').siblings("td:nth-child(4)").data('total', total);
                        searchTr.children('td').siblings("td:nth-child(4)").text('$'+total+' mxn');
                        console.log(firstItem);
                    }
                    
                } else {

                    // Se llena la información del item
                    $(".productosCilindroPedidoForm tbody").append(
                        '<tr data-item-id='+articulo.article+' class="product-item" data-item=' + "'" + JSON.stringify(articulo) + "'" + '>' +
                            '<td class="text-center">'+(artSel && artSel.nombre ? artSel.nombre : 'Sin nombre asignado')+'</td>'+
                            '<td class="text-center">'+articulo['quantity']+'</td>'+
                            '<td class="text-center">'+capacidad+' kg</td>'+
                            '<td class="text-center" data-total='+total+'>$'+total+' mxn</td>'+
                            // '<td class="text-center">'+(envase ? 'Si' : 'No')+'</td>'+
                            '<td class="text-center">'+
                                '<button class="btn btn-sm btn-info edit-producto-cil"> <i class="fa fa-pen-to-square"></i> </button> '+
                                '<button class="btn btn-sm btn-danger delete-producto-cil" data-table-ref=".productosCilindroPedidoForm" data-item-id='+articulo.article+'> <i class="fa-solid fa-trash-can"></i> </button>'+
                            '</td>'+
                        '</tr>'
                    );

                }

                setTotalPedido( $(".productosCilindroPedidoForm") );

            } else if ( tipoProducto == 'estacionario' ) {// Estacionario

                $('.productosEstacionarioPedidoForm').parent().parent().removeClass('d-none');
                
                let total  = parseFloat( $('#totalFormProductos').val() ).toFixed(2);
                let litros = parseInt( $("#litrosFormProductos").val() );
                let articulo = {
                    "zoneprice" : prices,// Este es el valor de la zona
                    "tipo"      : 2,
                    "capacity"  : litros,
                    "quantity"  : 1,
                    "article"   : articuloGasLp// ID de GAS LP
                };

                if ( searchTr.length ) {// Se verifica si el artículo fue previamente registrado
                    
                    if ( productoId ) {// Si es una edición, se reemplazará todo el contenido
                        console.log("jeje");
                        searchTr.data('item', articulo);
                        searchTr.children('td').siblings("td:nth-child(3)").text(articulo['capacity']);
                        searchTr.children('td').siblings("td:nth-child(4)").data('total', total);
                        searchTr.children('td').siblings("td:nth-child(4)").text('$'+total+' mxn');
                    } else {// Se suma el consumo del cliente
                        console.log("jeje2");
                        let firstItem         = searchTr.data('item');
                        let firstTotal        = parseFloat( searchTr.children('td').siblings("td:nth-child(4)").data('total') ).toFixed(2);
                        firstItem['capacity'] = Number(firstItem['capacity']) + Number(articulo['capacity']);
        
                        total = parseFloat(Number(total) + Number(firstTotal)).toFixed(2);
                        searchTr.data('item', firstItem);
                        searchTr.children('td').siblings("td:nth-child(3)").text(firstItem['capacity']);
                        searchTr.children('td').siblings("td:nth-child(4)").data('total', total);
                        searchTr.children('td').siblings("td:nth-child(4)").text('$'+total+' mxn');
                        console.log(firstItem);
                    }

                } else {// Se llena la información del item
                    
                    $(".productosEstacionarioPedidoForm tbody").append(
                        '<tr data-item-id='+articulo.article+' class="product-item" data-item=' + "'" + JSON.stringify(articulo) + "'" + '>' +
                            '<td>Gas LP</td>'+
                            '<td class="text-center">1</td>'+
                            '<td class="text-center">'+$("#litrosFormProductos").val()+'</td>'+
                            '<td class="text-center" data-total='+total+'>$'+total+' mxn</td>'+
                            '<td class="text-center">'+
                                '<button class="btn btn-sm btn-info edit-producto-est"> <i class="fa fa-pen-to-square"></i> </button> '+
                                '<button class="btn btn-sm btn-danger delete-producto-est" data-table-ref=".productosEstacionarioPedidoForm" data-item-id='+articulo.article+'> <i class="fa-solid fa-trash-can"></i> </button>'+
                            '</td>'+
                        '</tr>'
                    );

                }

                setTotalPedido( $(".productosEstacionarioPedidoForm") );

            }

            // Desvanece el modal
            $('#formProductosModal').modal('hide');
        });

        // Valida la información mostrada en la lista de artículos
        function validarTablaProductos(table) {
            if (! table.children('tbody').children('tr.product-item').length ) {
                table.parent().parent().addClass('d-none');
                $('#sinProductos').removeClass('d-none');
            }

            setTotalPedido(table);
        }

        // Agrega un método de pago nuevo
        $('#guardarMetodoPagoForm').on('click', function () {
            let canContinue = false;
            // let conFolio    = ["8", "2", "5", "6"];
            let metodoId    = $("#metodoPagoPedido").val();
            let metodoTxt   = $('#metodoPagoPedido').children(':selected').text();
            // let numMetodos  = $('table.productosMetodoPago tbody').children('tr.metodos').length;

            if(!metodoId || !$("#montoPagoPedido").val() ) {
                canContinue = false;
            } else {
                canContinue = true;
            }

            if(! canContinue ) { 
                alert("Favor de llenar todos los campos con *");
                return; 
            }

            // let searchTr = $('table.productosMetodoPago > tbody > tr[data-metodo-id="'+metodoId+'"]');

            $('#sinMetodosPago').addClass('d-none');
            $('.productosMetodoPagoForm').parent().parent().removeClass('d-none');

            let total        = parseFloat($('#montoPagoPedido').val()).toFixed(2);
            let folio        = $('#folioAutorizacionPedido').val().trim();
            let metodoObj    = {
                metodo_txt : metodoTxt,
                tipo_pago  : metodoId,
                monto      : total,
                folio      : folio,
            };

            agregarMetodoPago(metodoObj);

            // if ( searchTr.length ) {// Se verifica si el artículo fue previamente registrado y se edita el row

            //     searchTr.data('metodo', metodoObj);
            //     searchTr.children('td').siblings("td:nth-child(2)").text(folio ? folio : 'No aplica');
            //     searchTr.children('td').siblings("td:nth-child(3)").data('total', total);
            //     searchTr.children('td').siblings("td:nth-child(3)").text('$'+total+' mxn');
            //     console.log(metodoObj);
                
            // } else {// Se llena la información del item
                
            //     $(".productosMetodoPago tbody").append(
            //         '<tr data-metodo-id='+metodoId+' class="metodo-item" data-metodo=' + "'" + JSON.stringify(metodoObj) + "'" + '>' +
            //             '<td>'+metodoNombre+'</td>'+
            //             '<td class="text-center">'+(folio ? folio : 'No aplica')+'</td>'+
            //             '<td class="text-center" data-total='+total+'>$'+total+' mxn</td>'+
            //             '<td class="text-center">'+
            //                 '<button class="btn btn-sm btn-danger delete-metodo-pago" data-table-ref=".productosMetodoPago" data-metodo-id='+metodoId+'> <i class="fa-solid fa-trash-can"></i> </button>'+
            //             '</td>'+
            //         '</tr>'
            //     );

            // }
        
            // Falta código para setear un total
            setTotalMetodoPago( $(".productosMetodoPagoForm") );
            $('#formMetodoPagosModal').modal('hide');

        });

        // Calcula el total del método de pago
        function setTotalMetodoPago(table, tipoDescuento = 'nativo') {
            let total = parseFloat(0).toFixed(2);

            if ( tipoDescuento == 'nativo' ) { // Validación para especificar el descuento natural que puede tener el cliente
                table.children('tbody').children('tr.metodo-item').each(function() {
                    // let articulo = $( this ).data('item');
                    let subtotal = parseFloat($( this ).children('td').siblings("td:nth-child(3)").data('total')).toFixed(2);
                    total = Number(total) + Number(subtotal);
                });
            } else if ( tipoDescuento == 'resurtido' ) {// Descuento por devolución de cilindro
                total = parseFloat(0).toFixed(2);
            } else if ( tipoDescuento == 'nota' ) {// Descuento por nota de crédito asociado a Gas LP

            }

            table.children('tfoot').find('td.total').data('total', parseFloat(total).toFixed(2));
            table.children('tfoot').find('td.total').text('$'+parseFloat(total).toFixed(2)+' mxn');
        }

        // Agrega un método de pago a la tabla de métodos
        function agregarMetodoPago(metodoObj) {
            let searchTr = $('table.productosMetodoPagoForm > tbody > tr[data-metodo-id="'+metodoObj.tipo_pago+'"]');

            if ( searchTr.length ) {// Se verifica si el artículo fue previamente registrado y se edita el row

                searchTr.data('metodo', metodoObj);
                searchTr.children('td').siblings("td:nth-child(2)").text(metodoObj.folio ? metodoObj.folio : 'No aplica');
                searchTr.children('td').siblings("td:nth-child(3)").data('total', metodoObj.monto);
                searchTr.children('td').siblings("td:nth-child(3)").text('$'+metodoObj.monto+' mxn');
                console.log(metodoObj);
                
            } else {// Se llena la información del item
                
                $(".productosMetodoPagoForm tbody").append(
                    '<tr data-metodo-id='+metodoObj.tipo_pago+' class="metodo-item" data-metodo=' + "'" + JSON.stringify(metodoObj) + "'" + '>' +
                        '<td>'+metodoObj.metodo_txt+'</td>'+
                        '<td class="text-center">'+(metodoObj.folio ? metodoObj.folio : 'No aplica')+'</td>'+
                        '<td class="text-center" data-total='+metodoObj.monto+'>$'+metodoObj.monto+' mxn</td>'+
                        '<td class="text-center">'+
                            '<button class="btn btn-sm btn-danger delete-metodo-pago" data-table-ref=".productosMetodoPagoForm" data-metodo-id='+metodoObj.tipo_pago+'> <i class="fa-solid fa-trash-can"></i> </button>'+
                        '</td>'+
                    '</tr>'
                );

            }
        }

        // Elimina un método de pago de la tabla
        $('body').delegate('.delete-metodo-pago','click', function() {
            let metodo  = $(this).parent().parent().data('metodo');
            let table = $(this).data('table-ref');
            let id    = ( metodo && metodo.tipo_pago ? metodo.tipo_pago : 0 );

            swal({
                title: '¿Desea eliminar el método de pago seleccionado?',
                icon: 'warning',
                buttons:["Cancelar", "Aceptar"],
                dangerMode: true,
            }).then((accept) => {
                if ( accept ) {
                    $(table).children('tbody').children('tr[data-metodo-id="'+id+'"]').remove();
                    validarTablaMetodosPago( $(table) );
                }
            }).catch(swal.noop);
        });

        // Valida la información mostrada en la lista de métodos de pago
        function validarTablaMetodosPago(table) {
            if (! table.children('tbody').children('tr.metodo-item').length ) {
                table.parent().parent().addClass('d-none');
                $('#sinMetodosPago').removeClass('d-none');
            }

            setTotalMetodosPago(table);
        }

        // Calcula el total de los métodos de pago agregados
        function setTotalMetodosPago(table) {
            let total = parseFloat(0).toFixed(2);

            table.children('tbody').children('tr.metodo-item').each(function() {
                // let articulo = $( this ).data('item');
                let subtotal = parseFloat($( this ).children('td').siblings("td:nth-child(3)").data('total')).toFixed(2);
                total = parseFloat( Number(total) + Number(subtotal) ).toFixed(2);
            });

            table.children('tfoot').find('td.total').data('total', total);
            table.children('tfoot').find('td.total').text('$'+total+' mxn');
        }

        // Elimina un artículo de la tabla
        $('body').delegate('.delete-producto-cil, .delete-producto-est','click', function() {
            let item  = $(this).parent().parent().data('item');
            let table = $(this).data('table-ref');
            let id    = ( item && item.article ? item.article : 0 );

            swal({
                title: 'Se dará de baja el producto seleccionado, ¿Está seguro de continuar?',
                icon: 'warning',
                buttons:["Cancelar", "Aceptar"],
                dangerMode: true,
            }).then((accept) => {
                if ( accept ) {
                    $(table).children('tbody').children('tr[data-item-id="'+id+'"]').remove();
                    validarTablaProductos( $(table) );
                }
            }).catch(swal.noop);
        });

        // Valida la información que se mostrará en el modal
        $("#agregarProducto").click(function () {
            let pedido   = $("#formConfirmarPedidos").data("item");
            let minimoGasLp = Number($('select#plantas').children(':selected').data('pedido-minimo'));
            $('.minimo-gas-lp').text(minimoGasLp);

            console.log(pedido);
            
            if ( pedido ) {
                let item1Id        = Number(parseInt(pedido.item1Id));
                let item1Capacidad = Number(parseInt(pedido.capacidad1));

                if ( pedido.serviceTypeId == 1 ) {// Cilindro
                    $("#productoFormProductos").val("cilindro");
                    $("#totalFormProductos").prop('readonly', true);
                    $(".cilindroFormProductos").removeClass("d-none");
                    $(".estacionarioFormProductos").addClass("d-none");
                    // Se realiza el cálculo del total
                    $('#cantidadFormProductos').val(item1Capacidad);
                    $('#capacidadFormProductos').val(item1Id);
                    onChangeValue( $('input#cantidadFormProductos') );
                } else if ( pedido.serviceTypeId == 2 ) {// Estacionario
                    $('.info-minimo-gas-lp').removeClass('d-none');
                    $("#productoFormProductos").val("estacionario");
                    $("#totalFormProductos").attr('readonly', false);
                    $(".estacionarioFormProductos").removeClass("d-none");
                    $(".cilindroFormProductos").addClass("d-none");
                    // Se realiza el cálculo del total
                    $('#litrosFormProductos').val(item1Capacidad);
                    onChangeValue( $('input#litrosFormProductos') );
                } else if ( pedido.serviceTypeId == 4 ) {// Ambos
                    
                }
            }

            // Se validan los option disponibles si es que algún producto ya fue registrado
            if (! $('table.productosEstacionarioPedidoForm').parent().parent().hasClass('d-none') ) {// Ya se agregó gas LP
                $(".opt-pro-pedido-cilindro").attr("disabled", true);
            } else if (! $('table.productosCilindroPedidoForm').parent().parent().hasClass('d-none') ) {// Ya se agregó un cilindro
                $(".opt-pro-pedido-estacionario").attr("disabled", true);
            } else {
                // $(".opt-pro-pedido-cilindro, .opt-pro-pedido-estacionario").attr("disabled", false);
            }

            $("#envaseFormProductos").prop("checked", false);
            $('#formProductosModal').modal('show');
        });

        // Calcula el total de los productos
        // Parámetros: 
        // table: La tabla a realizar el cálculo de total de descuento
        // table: El tipo de desucento a enviar: nativo, resurtido (Cilindro), nota crédito(Gas LP) 
        function setTotalPedido(table, tipoDescuento = 'nativo') {
            let total           = parseFloat(0).toFixed(2);
            let totalDescontado = parseFloat(0).toFixed(2);
            let totalLitros     = parseFloat(0).toFixed(2);
            let descuento       = Number( parseFloat($("#formConfirmarPedidos").data("item").discount ?? 0).toFixed(2) );
            // console.log(descuento);
            table.children('tbody').children('tr.product-item').each(function() {
                let articulo = $( this ).data('item');
                if ( articulo.tipo == '1' ) { // Cilindro
                    totalLitros = Number(totalLitros) + Number( parseFloat(articulo.capacity * articulo.quantity).toFixed(2) );
                } else if  ( articulo.tipo == '2' ) { // Estacionario
                    totalLitros = Number(totalLitros) + Number( parseFloat(articulo.capacity).toFixed(2) );
                }
                let subtotal = parseFloat($( this ).children('td').siblings("td:nth-child(4)").data('total')).toFixed(2);
                total = parseFloat( Number(total) + Number(subtotal) ).toFixed(2);
            });

            if ( tipoDescuento == 'nativo' ) { // Validación para especificar el descuento natural que puede tener el cliente
                if ( $("#formConfirmarPedidos").data("item").typeDiscount == '1' ) { // Porcentaje
                    descuento = Number( parseFloat( descuento / 100 ).toFixed(2) );
                    totalDescontado = Number( parseFloat( descuento * total ).toFixed(2) );
                } else if ( $("#formConfirmarPedidos").data("item").typeDiscount == '2' ) { // Neto
                    totalDescontado = Number( parseFloat( totalLitros * descuento ).toFixed(2) );
                }
            } else if ( tipoDescuento == 'resurtido' ) {// Descuento por devolución de cilindro
                totalDescontado = Number( parseFloat( total).toFixed(2)) ;
                console.log('Tipo: ', tipoDescuento);
            } else if ( tipoDescuento == 'nota' ) {// Descuento por nota de crédito asociado a Gas LP

            }

            total = parseFloat( Number(total) - Number(totalDescontado) ).toFixed(2);
            
            // Se asigna el descuento
            table.children('tfoot').find('td.descuento').data('descuento', totalDescontado);
            table.children('tfoot').find('td.descuento').text('$'+totalDescontado+' mxn');

            // Se asigna el total
            table.children('tfoot').find('td.total').data('total', total);
            table.children('tfoot').find('td.total').text('$'+total+' mxn');
        }

        // Agrega el envase seleccionado de un cilindro
        function agregarEnvase(conEnvase, table, cilindro, zonaVenta) {
            if (! conEnvase ) { return; }// Sólo si tiene envase valida el proceso

            let artEnvase = null; 

            // Si el tipo de artículo es envase y coincide con la capacidad del artículo seleccionado
            for (let i = 0; i < articulosArr.length; i++) {
                if ( articulosArr[i].tipo_articulo == 5 && articulosArr[i].capacidad_litros == cilindro.capacidad_litros ) {
                    artEnvase = articulosArr[i];
                }
                
            }
            
            if (! artEnvase ) { return; }// No encontró el envase del artículo y no agrega nada

            let searchTr = $('tr[data-item-id="'+artEnvase.id+'"]');
            
            if (! searchTr.length ) {// Se verifica si el artículo fue previamente registrado

                let artObj  = {
                    "zoneprice" : zonaVenta,// Este es el valor de la zona
                    "tipo"      : 5,
                    "precio"    : artEnvase.basePrice * 1.16,
                    "capacity"  : artEnvase.capacidad_litros,
                    "quantity"  : 1,
                    "article"   : artEnvase.id
                };

                let total = parseFloat( Number(artEnvase.basePrice) * 1.16 ).toFixed(2);

                // Se llena la información del item
                $(table).children("tbody").append(
                    '<tr data-item-id='+artEnvase.id+' class="product-item" data-item=' + "'" + JSON.stringify(artObj) + "'" + '>' +
                        '<td class="text-center">'+(artEnvase.nombre ? artEnvase.nombre : 'Sin nombre asignado')+'</td>'+
                        '<td class="text-center">'+artObj['quantity']+'</td>'+
                        '<td class="text-center">'+artObj['capacity']+' kg</td>'+
                        '<td class="text-center" data-total='+total+'>$'+total+' mxn</td>'+
                        '<td class="text-center">'+
                            // '<button class="btn btn-sm btn-info edit-producto-cil"> <i class="fa fa-pen-to-square"></i> </button> '+
                            '<button class="btn btn-sm btn-danger delete-producto-cil" data-table-ref=".productosCilindroPedidoForm" data-item-id='+artEnvase.id+'> <i class="fa-solid fa-trash-can"></i> </button>'+
                        '</td>'+
                    '</tr>'
                );
                
            } else {
                
                console.log('El envase ya había sido agregado');

            }
        }


        $( "input#litrosFormProductos, input#cantidadFormProductos, input#totalFormProductos" ).on('change keyup paste', function(e) {
            onChangeValue( $(this) );
        });

        $('select#productoFormProductos, select#capacidadFormProductos').on('change', function(e) {
            onChangeValue( $(this) );
        });

        function onChangeValue(element) {
            var elementId    = element.attr('id');
            let subtotal     = total = 0;
            let tipoProducto = $('#productoFormProductos').val();
            let prices       = $("#formConfirmarPedidos").data("item").precioZona;
            let cantidad     = parseInt( $('#cantidadFormProductos').val() );
            let litros       = parseInt( $('#litrosFormProductos').val() );
            let valor        = parseFloat( $('#valorFormProductos').val() ).toFixed(2);
            let articulo     = $('#capacidadFormProductos').children(':selected').data('articulo');
            console.log(articulo);
            let capArticulo  = ( articulo && articulo.capacidad_litros ? articulo.capacidad_litros : 0 );
            
            cantidad = ( isNaN(cantidad) ? 0 : cantidad );
            litros   = ( isNaN(litros) ? 0 : litros );
            valor    = ( isNaN(valor) ? 0 : valor );

            if ( tipoProducto == 'cilindro' ) {// Cilindro
                if ( elementId == 'cantidadFormProductos' || elementId == 'capacidadFormProductos' || elementId == 'productoFormProductos' ) {// Producto (cilindro) y cantidad de producto

                    subtotal = parseFloat( capArticulo *  cantidad * prices).toFixed(2);
                    $('#valorFormProductos').val(subtotal);

                } else if ( elementId == 'cantidadFormProductos' ) {// Se resetea el formulario ¿?

                }

                total = parseFloat(subtotal * 1.16).toFixed(2);
                $('#totalFormProductos').val(total);
                
            } else if ( tipoProducto == 'estacionario' ) {// Estacionario
                if ( elementId == 'totalFormProductos' || elementId == 'productoFormProductos' ) {// Se calculan los litros a contratar

                    total = parseFloat( $('#totalFormProductos').val() ).toFixed(2);
                    total = ( isNaN(total) ? 0 : total );
                    subtotal = parseFloat(total / 1.16).toFixed(2);
                    // subtotal = Math.ceil( $('#valorFormProductos').val() );
                    // subtotal = ( isNaN(subtotal) ? 0 : subtotal );
                    litros = parseFloat(subtotal / prices).toFixed(2);
                    $('#litrosFormProductos').val(litros);

                } else if( elementId == 'litrosFormProductos' ) {// Se calcula el total acorde a los litros

                    subtotal = parseInt(litros * prices); 
                    total = parseFloat(subtotal * 1.16).toFixed(2);
                    $('#totalFormProductos').val(total);
                    
                } else if ( elementId == 'cantidadFormProductos' ) {// 

                }

                $('#valorFormProductos').val(subtotal);
            
            } else {// Todo se coloca en 0
                
            }
        }

        // Valida la información mostrada en el modal del producto
        $('select#productoFormProductos').on('change', function(e) {
            let val = $(this).val();
            $('.info-minimo-gas-lp').addClass('d-none');
            if ( val == "cilindro" ) {
                $("#totalFormProductos").prop('readonly', true);
                $(".cilindroFormProductos").removeClass("d-none");
                $(".estacionarioFormProductos").addClass("d-none");
                // $(".opt-pro-pedido-cilindro").attr("disabled", false);
            } else if ( val == "estacionario" ) {
                $('.info-minimo-gas-lp').removeClass('d-none');
                $("#totalFormProductos").attr('readonly', false);
                $(".estacionarioFormProductos").removeClass("d-none");
                $(".cilindroFormProductos").addClass("d-none");
                // $(".opt-pro-pedido-estacionario").attr("disabled", false);
            } else {
                $("#totalFormProductos").prop('readonly', true);
                $(".estacionarioFormProductos, .cilindroFormProductos").addClass("d-none");
                // $(".opt-pro-pedido-cilindro, .opt-pro-pedido-estacionario").attr("disabled", true);
            }
        });

        // Limpia los campos del modal para agregar producto
        $('body').delegate('div#formProductosModal', 'hidden.bs.modal', function () {
            $('.info-minimo-gas-lp').addClass('d-none');
            $('.cilindroFormProductos').addClass('d-none');
            $('.estacionarioFormProductos').addClass('d-none');

            $("#envaseFormProductos").prop("checked", false);
            $("#cantidadFormProductos, #litrosFormProductos, #valorFormProductos, #totalFormProductos").val(0);
            $("#productoFormProductos, #pedidoProductoId").val("");
            $(".opt-pro-pedido-cilindro, .opt-pro-pedido-estacionario").prop("disabled", false);
            $("#totalFormProductos").prop('readonly', true);
        });

        function setSelectRutas(getPedidos = false) {
            $('#filterRuta').parent().parent().removeClass("d-none");
            $('#filterRuta').children('option').remove();    
            $("#filterRuta").append(
                '<option value="0">Todas</option>'
            );
            if ( rutasCilindros.length || rutasEstacionarios.length) {        
                if($("#filterTipoProducto").val() == "0" || $("#filterTipoProducto").val() == "1") {
                    rutasCilindros.forEach(element => {
                        $("#filterRuta").append(
                            '<option value="'+element.internalId+'">'+getRutaFormat(element, "ruta")+'</option>'
                        );
                    });
                }
                if($("#filterTipoProducto").val() == "0" || $("#filterTipoProducto").val() == "2") {
                    rutasEstacionarios.forEach(element => {
                        $("#filterRuta").append(
                            '<option value="'+element.internalId+'">'+getRutaFormat(element, "ruta")+'</option>'
                        );
                    });
                }
                if($("#filterTipoProducto").val() == "3") {
                    $('#filterRuta').parent().parent().addClass("d-none");
                }
                $('#filterRuta').select2({
                    selectOnClose: true,
                    placeholder: "Seleccione una opción",
                    language: {
                        "noResults": function(){
                            return "Sin resultados encontrados";
                        }
                    }
                });
                if(getPedidos) {
                    getServicios(this);
                }        
                readyInit();
            } else {
                console.warn('No hay rutas por cargar');
                readyInit();
            }
        }

        function getRutaFormat(item, tipo) { 
            let auxRut = "";
            let auxRuta = item.name;
            if(tipo == "pedido") {
                auxRuta = item.rutaNombre;
            } else if(tipo == "viajes") {
                auxRuta = item.ruta;
            }
            auxRut += (auxRuta && auxRuta.trim() ? (auxRuta.trim().split(":").length > 1 ? auxRuta.trim().split(":")[1].trim() : auxRuta.trim()) : '')

            if(auxRuta && auxRut.trim()) {
                auxRut = auxRut.trim();
                let rout = auxRut.split(" - ").length > 1 ? auxRut.split(" - ")[0] : auxRut;
                rout = rout.split("-").length > 2 ? rout.split("-")[2] : rout.trim();
                if(tipo == "pedido") {
                    auxRut = rout + " (" + (item.turno && item.turno.trim() ? item.turno.trim() : 'Sin especificar') + ")";
                } else if(tipo == "ruta") {
                    auxRut = rout;
                } else if(tipo == "viajes") {
                    auxRut = rout + " (" + (item.turno && item.turno.trim() ? item.turno.trim() : 'Sin especificar') + ")";
                }
            }
                
            return auxRut;
        }

        $("#plantas").change(function() {
            getRutas(true);
        });

        // Función para obtener los tipos de servicios
        function getTiposServicios() {
            let settings = {
                url      : urlTiposServicios,
                method   : 'GET'
            }

            setAjax(settings).then((response) => {
                setSelectTiposServicios((response.data));
            }).catch((error) => {
                console.log(error);
            });
        }
        vrTiposServicios = [];
        // Método para llenar el select de los estado de la oportunidad
        function setSelectTiposServicios(items) {
            vrTiposServicios = [];
            if ( items.length ) {
                $('#filterTipoProducto').children('option').remove();
                for ( var key in items ) {
                    vrTiposServicios.push(items[key]);
                    if ( items.hasOwnProperty( key ) && items[key].id != "3" && items[key].id != "4") {
                        $("#filterTipoProducto").append(
                            '<option value="'+items[key].id+'">'+items[key].nombre+'</option>'
                        );
                    }
                }
                readyInit();
            } else {
                console.warn('No hay estados de solicitud por cargar');
                readyInit();
            }
        }

        function getFiltPedidos() {
            let filt = {};

            if($("#plantas").val()) {
                filt.planta = $("#plantas").val();
            }

            if($("#filterRuta").val() != "0" && $("#filterRuta").val()) {
                filt.ruta = $("#filterRuta").val();
            }

            if($("#filterZona").val() != "0") {
                filt.colonia = $("#filterZona").val();
            }

            filt.tipo_producto = parseInt($("#filterTipoProducto").val());

            filt.status_alert = $("#filterEstadoSeguimiento").val();

            vrStatus.forEach(element => {
                if(element.nombre.toLowerCase() == "por confirmar") {
                    filt.status_oportunidad = element.id;
                }
            });

            //filt.fechaPrometida1 = dateFormatFromDate($("#filterProximaLlamada").val(), "5");
            //filt.fechaPrometida2 = dateFormatFromDate($("#filterProximaLlamada").val(), "5");

            return filt;
        }

        $("#guardarNotaAdicional").click(function () {
            if ($("#notaAdicional").val().trim()) {
                $("#notasAdicionales tbody").append(
                    '<tr class="notasAdicionalesItem">' +
                        '<td class="p-2">' +
                            $("#notaAdicional").val().trim() +
                        '</td>' +
                        '<td width="50" style="text-align: center;">' +
                            '<i class="fa-solid fa-trash-can" style="cursor: pointer;" onclick="deleteNota(this)"></i>' +
                        '</td>' +
                    '</tr>'
                );
                $("#formNotasAdicionalesModal").modal("hide");
            } else {
                alert("Llena la nota.");
            }

        });

        function deleteNota(item) {
            $(item).parent().parent().remove();
        }

        function removeDuplicates(originalArray, prop) {
            var newArray = [];
            var lookupObject = {};

            for (var i in originalArray) {
            lookupObject[originalArray[i][prop]] = originalArray[i];
            }

            for (i in lookupObject) {
            newArray.push(lookupObject[i]);
            }
            return newArray;
        }

        function initTable(table) {
            $("#"+table).fancyTable({
                sortColumn:0,
                pagination: true,
                perPage: 10,
                searchable:false,
                sortable: false
            });
        }

        function dateFormatFromString(datetime, format = "1") {
            if (format == "1") {
                let date = datetime.split(" ")[0].split("-");
                let time = [0, 0, 0]
                if (datetime.split(" ").length > 1) {
                    time = datetime.split(" ")[1].split(":");
                    if (datetime.split(" ")[2] == "PM") {
                        time[0] = parseInt(time[0]) + 12;
                    }
                }
                
                return new Date(date[0], parseInt(date[1]) - 1, date[2], time[0], time[1]);
            } else if (format == "2") {
                let date = datetime.split(" ")[0].split("/");
                let time = [0, 0];
                if (datetime.split(" ").length > 1) {
                    time = datetime.split(" ")[1].split(":");
                    if (datetime.split(" ")[2] == "PM") {
                        time[0] = parseInt(time[0]) + 12;
                    }
                }
                return new Date(date[2], parseInt(date[1]) - 1, date[0], time[0], time[1]);
            }
        }

        function getTimeFromString(time) {
            let aux = time.split(" "),
            aux2 = aux[0].split(":");
            if (aux.length > 1 && (aux[1].toLowerCase() == "pm" || aux[1].toLowerCase() == "p.m")) {
                if(parseInt(aux2[0]) < 12) {
                    aux2[0] = parseInt(aux2[0]) + 12;
                }                
            } else {
                if(aux2[0].toString().length == 1) {
                    aux2[0] = "0"+aux2[0].toString();
                }
                if(parseInt(aux2[0]) == 12) {
                    aux2[0] = "00";
                }
            }

            return aux2[0].toString() + ":" + aux2[1];

        }

        function getServicios() {
            let settings = {
                url      : urlGetOpp,
                method   : 'POST',
                data: JSON.stringify(getFiltPedidos())
            }
            if(!swal.getState().isOpen) {
                loadMsg();
            }
            
            $("#tablePedidos tbody").children("tr").remove();
            setAjax(settings).then((response) => {   
                console.log(response);     
                if(response.success) {
                    response.data = removeDuplicates(response.data, 'no_pedido');
                    if(response.data.length == 0) {
                        $("#tablePedidos tbody").append('<tr><td colspan="11" class="text-center fw-bold py-5">Sin pedidos encontrados</td></tr>');
                        initTable("tablePedidos");
                    }
                    
                    response.data.forEach((pedido, position) => {
                        if(pedido.fecha_prometida) {
                            pedido.fecha_hora_prometida = dateFormatFromString(pedido.fecha_prometida, "2");
                            pedido.fecha_prometida = dateFormatFromDate(new Date(pedido.fecha_prometida.split("/")[2], parseInt(pedido.fecha_prometida.split("/")[1]) - 1, pedido.fecha_prometida.split("/")[0]), "2");
                        }
                
                        if(pedido.fecha_solicitud) {
                            pedido.fecha_solicitud = dateFormatFromDate(new Date(pedido.fecha_solicitud.split("/")[2], parseInt(pedido.fecha_solicitud.split("/")[1]) - 1, pedido.fecha_solicitud.split("/")[0]), "2");
                        }
                                    
                        if(pedido.fecha_notificacion) {
                            pedido.fecha_hora_notificacion = dateFormatFromString(pedido.fecha_notificacion+(pedido.hora_notificacion ? " "+pedido.hora_notificacion : ''), "2");
                            pedido.fecha_notificacion = dateFormatFromDate(new Date(pedido.fecha_notificacion.split("/")[2], parseInt(pedido.fecha_notificacion.split("/")[1]) - 1, pedido.fecha_notificacion.split("/")[0]), "2");
                        }
                        vrStatus.forEach(element2 => {
                            if(element2.id == pedido.status_id) {
                                pedido.estado = element2.nombre;
                            }
                        });
                        if(pedido.desde) {
                            pedido.desde = getTimeFromString(pedido.desde);
                        }
                        if(pedido.hasta) {
                            pedido.hasta = getTimeFromString(pedido.hasta);
                        }
                    });
                    
                    $("#tablePedidos thead tr th").css('z-index', "3");
                    $($("#tablePedidos thead tr th")[0]).css('z-index', "4");
                    $($("#tablePedidos thead tr th")[1]).css('z-index', "4");
                    
                    response.data.forEach((pedido, position) => {
                        let tipoServicio = "";
                        vrTiposServicios.forEach(element => {
                            if(pedido.servicio == element.id) {
                                tipoServicio = element.nombre;
                            }
                        });
                        let auxDir = getDireccionFormat(pedido),
                            auxObs = getObservacionesFormat(pedido, "<br>");
                        let trAux = '<tr data-item='+"'"+JSON.stringify(pedido)+"'"+'>'+
                                        '<td class="text-center sticky-col">'+  
                                            '<div class="btn-group dropend vertical-center">'+                                            
                                                '<i class="fa-solid fa-ellipsis-vertical c-pointer dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" style="font-size: 24px;"></i>'+
                                                '<ul class="dropdown-menu" style="width: max-content;">'+
                                                    '<li onclick="confirmarServicio(this)" class="px-2 py-1 c-pointer" style="font-size: 16px"><i class="fa-solid fa-square-check color-primary"></i> Confirmar servicio</li>'+
                                                    '<li onclick="reprogramarServicio(this)" class="px-2 py-1 c-pointer" style="font-size: 16px"><i class="fa-regular fa-calendar-days color-primary"></i> Reprogramar servicio</li>'+
                                                    '<li onclick="cambiarEstadoServicio(this)" class="px-2 py-1 c-pointer" style="font-size: 16px"><i class="fa-solid fa-arrows-rotate color-primary"></i> Cambiar estado</li>'+
                                                    '<li onclick="seguimientoPedido(this)" class="px-2 py-1 c-pointer" style="font-size: 16px"><i class="fa-solid fa-comment-dots color-primary"></i> Seguimiento</li>'+
                                                '</ul>'+
                                            '</div>'+
                                            '<div style="position: absolute; right: 0; top: 0; height: 100%; width: 1px; background-color: #000;"></div>'+
                                        '</td>'+
                                        '<td style="left: 40px;"class="text-center sticky-col">'+
                                            '<i onclick="verDetalles(this)" class="fa-solid fa-eye color-primary c-pointer" title="Ver detalles" data-bs-toggle="tooltip" data-bs-placement="right"></i>'+
                                            '<div style="position: absolute; right: 0; top: 0; height: 100%; width: 1px; background-color: #000;"></div>'+
                                        '</td>'+
                                        '<td class="text-center">' + pedido.documentNumber + '</td>'+
                                        '<td class="text-center">' + pedido.id_cliente + '</td>'+
                                        '<td class="text-center">Aviso</td>'+
                                        '<td class="text-center">' + dateFormatFromDate(pedido.fecha_prometida, '5') + '</td>'+
                                        '<td class="text-center">' + (pedido.nombre_cliente ? pedido.nombre_cliente : 'Sin nombre de cliente') + '</td>'+
                                        '<td class="text-center">' + (pedido.statusAlertName ? pedido.statusAlertName : 'Sin estado asignado') + '</td>'+
                                        '<td class="text-center">' + (pedido.telefono ? pedido.telefono : 'Sin teléfono') + '</td>'+
                                        '<td class="text-center">' + tipoServicio + '</td>'+
                                        '<td class="text-center">' + (auxDir ? auxDir : 'Sin dirección') + '</td>'+
                                        '<td class="text-center">' + (auxObs ? auxObs : 'Sin observaciones') + '</td>'+
                                    '</tr>';
                                    
                        $("#tablePedidos tbody").append(trAux);

                        if(response.data.length == (position + 1)) {
                            initTable("tablePedidos");
                        }
                    });
                    swal.close();
                } else {
                    $("#tablePedidos tbody").append('<tr><td colspan="11" class="text-center fw-bold py-5">Sin pedidos encontrados</td></tr>');
                    swal.close();
                }
            }).catch((error) => {
                console.log(error);
                $("#tablePedidos tbody").append('<tr><td colspan="11" class="text-center fw-bold py-5">Sin pedidos encontrados</td></tr>');
                swal.close();
            });
        }

        function getObservacionesFormat(item, separador) { 
            let auxObs = "";
            auxObs += (item.observaciones && item.observaciones.trim() ? item.observaciones.trim() : '');
            if(item.objPagos) {
                let aux = JSON.parse(item.objPagos);
                if(aux.pago) {
                    aux.pago.forEach(element => {
                        if(concatObsPagos.indexOf(element.tipo_pago) > -1) {
                            if(auxObs != "") {
                                auxObs += separador;
                            }
                            auxObs += getMetodoPagoFormat(element);
                        }                    
                    });
                }
            }
            return auxObs.trim();
        }

        function getMetodoPagoFormat(item) {     
            return item.metodo_txt + (item.folio ? " - " + item.folio : '') + " - $" + item.monto;
        }

        function getDireccionFormat(item, tipo) {
            let auxDir = "";
            auxDir += (item.street && item.street.trim() ? item.street.trim() : '');
            auxDir += (item.nExterior && item.nExterior.trim() ? (auxDir ? ' #' : '#') + item.nExterior.trim() : '');
            auxDir += (item.nInterior && item.nInterior.trim() ? (auxDir ? ' Int. ' : 'Int. ') + item.nInterior.trim() : '');
            auxDir += (item.colonia && item.colonia.trim() ? (auxDir ? ', ' : '') + capitalizeFirstsLetter(item.colonia.trim()) : '');
            auxDir += (item.cp && item.cp.trim() ? (auxDir ? ', ' : '') + item.cp.trim() : '');
            auxDir += (item.municipio && item.municipio.trim() ? (auxDir ? ' ' : '') + capitalizeFirstsLetter(item.municipio.trim()) : '');
            auxDir += (item.estadoDireccion && item.estadoDireccion.trim() ? (auxDir ? ', ' : '') + capitalizeFirstsLetter(item.estadoDireccion.trim()) : '');
            return auxDir.trim();
        }

        function cambiarEstadoServicio($this) {
            let servicio = $($this).closest("tr").data("item");
            $("#cambiarEstadoPedido").html(servicio.documentNumber ? servicio.documentNumber : '');
            $("#estadoCambiarEstado").val(null).trigger("change");
            $("#cambiarEstadoOppMotivo").val(null).trigger("change")
            $("#cambiarEstadoOppObservaciones").val(null)
            $("#formCambiarEstadoModal").data("item", servicio);
            $("#formCambiarEstadoModal").modal("show");
        }

        $('body').delegate('#estadoCambiarEstado', 'change', function () {
            if($(this).val() == idCancelado) {
                $("#cambiarEstadoOppMotivo").parent().removeClass('d-none');
                $("#cambiarEstadoOppObservaciones").parent().removeClass('d-none');
            } else {
                $("#cambiarEstadoOppMotivo").parent().addClass('d-none');
                $("#cambiarEstadoOppObservaciones").parent().addClass('d-none');
            }
        });

        function seguimientoPedido($this) {
            let pedido = $($this).closest("tr").data("item");
            $("#seguimientoPedido").html(pedido.documentNumber ? pedido.documentNumber : '');
            let settings = {
                url      : urlGetNotesOfOPP,
                method   : 'POST',
                data     : JSON.stringify({opp : pedido.no_pedido}),
            }
            $("#nuevaNotaSeguimiento").val("");
            $("#sendSmsSeguimiento").prop("checked", true);
            $("#table-notas-seguimiento tbody").children("tr").remove();
            $("#table-notas-seguimiento tbody").append('<tr>' +
                                                            '<td colspan="3" class="text-center">' +
                                                                'Sin comentarios'+
                                                            '</td>' +
                                                        '</tr>');
            
            setAjax(settings).then((response) => {
                if(response.success) {
                    if(response.data.length > 0) {
                        $("#table-notas-seguimiento tbody").children("tr").remove();
                    }
                    response.data.forEach(element => {
                        if(element.note && element.note.trim()) {
                            let trAux = '<tr>' +
                                            '<td class="ion-text-center sticky-col fw-bold">'+element.author+'</td>'+
                                            '<td class="ion-text-center sticky-col fw-bold">'+element.date+'</td>'+
                                            '<td class="ion-text-center sticky-col fw-bold">'+element.note+'</td>'+
                                        '</tr>';
                            $("#table-notas-seguimiento tbody").append(trAux);
                        }
                        
                    });
                    $("#formSeguimientoModal").data("item", pedido);
                    $("#formSeguimientoModal").modal("show");
                }
            }).catch((error) => {
                console.log(error);
            });
        }

        function reprogramarServicio($this) {
            let servicio = $($this).closest("tr").data("item");
            $("#reprogramarPedido").html(servicio.documentNumber ? servicio.documentNumber : '');
            $("#fechaPrometidaReprogramar").val(dateFormatFromDate(servicio.fecha_prometida, "2"));
            $("#desdeReprogramar").val(servicio.desde ? getTimeFromString(servicio.desde) : null);
            $("#hastaReprogramar").val(servicio.hasta ? getTimeFromString(servicio.hasta) : null);
            $("#comentarioReprogramar").val("");
            $("#formReprogramarModal").data("item", servicio);
            $("#formReprogramarModal").modal("show");
        }

        $("#guardarReprogramar").click(function() {
            let servicio = $("#formReprogramarModal").data("item");
            if(!$("#fechaPrometidaReprogramar").val() ||
            !$("#desdeReprogramar").val() ||
            !$("#hastaReprogramar").val()) {
                let aux = "<ul>";
                if(!$("#fechaPrometidaReprogramar").val()) {
                    aux += "<li>Fecha prometida</li>";
                }
                if(!$("#desdeReprogramar").val()) {
                    aux += "<li>Desde</li>";
                }
                if(!$("#hastaReprogramar").val()) {
                    aux += "<li>Hasta</li>";
                }
                aux += "</ul>";
                infoMsg('warning', 'Campos requeridos:', aux);
                return;
            }
            confirmMsg("warning", "¿Seguro que desea reprogramar el servicio?", function(resp) {
                if(resp) {
                    let dataSend = {
                        "opportunitiesUpdate": [
                            {
                                "id": servicio.no_pedido,
                                "bodyFields": {
                                    "custbody_ptg_estado_pedido": idPorReprogramar,
                                    "expectedclosedate": dateFormatFromDate($("#fechaPrometidaReprogramar").val(), "5"),
                                    "custbody_ptg_entre_las": formatTime( $('#desdeReprogramar').val() ),
                                    "custbody_ptg_y_las" : formatTime( $('#hastaReprogramar').val())
                                },
                                "lines": [
                                    
                                ]
                            }
                        ]
                    };
                    loadMsg();
                    let settings = {
                        url      : urPutOppMonitor,
                        method   : 'PUT',
                        data: JSON.stringify(dataSend)
                    }
                    setAjax(settings).then((response) => {
                        if(response.success) {
                            if($("#comentarioReprogramar").val().trim()) {
                                let nota = [{ 
                                    type: "nota", 
                                    idRelacionado: servicio.no_pedido, 
                                    titulo: "Reprogramación de servicio", 
                                    nota: $("#comentarioReprogramar").val().trim(),
                                    transaccion: "oportunidad"
                                }];
                                let settings2 = {
                                    url      : urlPostNoteandMessage,
                                    method   : 'POST',
                                    data: JSON.stringify({ informacion: nota })
                                }
                                setAjax(settings2).then((response) => {
                                    if(response.success) {
                                        $("#formReprogramarModal").modal("hide");
                                        swal.close();
                                        infoMsg('success', '', "Servicio reprogramado de manera correcta", null, function(resp) {
                                            getServicios();
                                        }); 
                                    }
                                }).catch((error) => {
                                    $("#formReprogramarModal").modal("hide");
                                    swal.close();
                                    infoMsg('success', '', "Servicio reprogramado de manera correcta", null, function(resp) {
                                        getServicios();
                                    }); 
                                });
                            } else {
                                $("#formReprogramarModal").modal("hide");
                                swal.close();
                                infoMsg('success', '', "Servicio reprogramado de manera correcta", null, function(resp) {
                                    getServicios();
                                }); 
                            }                                                         
                        } else {
                            swal.close();
                            infoMsg('error', 'Error:', "Ocurrio un error al tratar de reprogramar el servicio");
                        }            
                    }).catch((error) => {
                        infoMsg('error', 'Error:', "Ocurrio un error al tratar de reprogramar el servicio");
                        console.log(error);
                        swal.close();
                    });
                }
            });
        });

        $("#guardarCambiarEstado").click(function() {
            let servicio = $("#formCambiarEstadoModal").data("item");
            if(!$("#estadoCambiarEstado").val() || ($("#estadoCambiarEstado").val() == idCancelado && (!$("#cambiarEstadoOppMotivo").val() || !$("#cambiarEstadoOppObservaciones").val().trim()))) {
                let aux = "<ul>";
                if(!$("#estadoCambiarEstado").val()) {
                    aux += "<li>Estado</li>";
                } 
                if($("#estadoCambiarEstado").val() == idCancelado) {
                    if(!$("#cambiarEstadoOppMotivo").val()) {
                        aux += "<li>Motivo de Cancelacion</li>";
                    } 
                    if(!$("#cambiarEstadoOppObservaciones").val()) {
                        aux += "<li>Observaciones</li>";
                    } 
                }
                
                aux += "</ul>";
                infoMsg('warning', 'Campos requeridos:', aux);
                return;
            }
            confirmMsg("warning", "¿Seguro que desea cambiar el estado del servicio?", function(resp) {
                if(resp) {
                    let dataSend = {
                        "opportunitiesUpdate": [
                            {
                                "id": servicio.no_pedido,
                                "bodyFields": {
                                    "custbody_ptg_estado_pedido": $("#estadoCambiarEstado").val(),
                                },
                                "lines": [
                                    
                                ]
                            }
                        ]
                    };
                    if($("#estadoCambiarEstado").val() == idCancelado) {
                        dataSend.opportunitiesUpdate[0].bodyFields.custbody_ptg_motivo_cancelation = $("#cambiarEstadoOppMotivo").val()
                    }
                    loadMsg();
                    let settings = {
                        url      : urPutOppMonitor,
                        method   : 'PUT',
                        data: JSON.stringify(dataSend)
                    }
                    setAjax(settings).then((response) => {
                        if(response.success) {
                            if($("#estadoCambiarEstado").val() == idCancelado) {
                                let nota = [{ 
                                    type: "nota", 
                                    idRelacionado: servicio.no_pedido, 
                                    titulo: "Cancelación de servicio", 
                                    nota: $("#cambiarEstadoOppObservaciones").val().trim(),
                                    transaccion: "oportunidad"
                                }];
                                let settings2 = {
                                    url      : urlPostNoteandMessage,
                                    method   : 'POST',
                                    data: JSON.stringify({ informacion: nota })
                                }
                                setAjax(settings2).then((response) => {
                                    if(response.success) {
                                        $("#formCambiarEstadoModal").modal("hide");
                                        swal.close();
                                        infoMsg('success', '', "Cambio de estado de manera correcta", null, function(resp) {
                                            getServicios();
                                        }); 
                                    }
                                }).catch((error) => {
                                    console.log(error);
                                    swal.close();
                                });
                            } else {
                                $("#formCambiarEstadoModal").modal("hide");
                                swal.close();
                                infoMsg('success', '', "Cambio de estado de manera correcta", null, function(resp) {
                                    getServicios();
                                });  
                            }                                                                            
                        } else {
                            swal.close();
                            infoMsg('error', 'Error:', "Ocurrio un error al tratar de reprogramar el servicio");
                        }            
                    }).catch((error) => {
                        infoMsg('error', 'Error:', "Ocurrio un error al tratar de reprogramar el servicio");
                        console.log(error);
                        swal.close();
                    });
                }
            });
        });

        function formatTime(value, format = 'hh:mm a') {
            let hora = value.split(':');
            let customDateTime = new Date();

            if ( hora.length ) {

                customDateTime.setHours(hora[0]);
                customDateTime.setMinutes(hora[1]);

                return moment(customDateTime).format(format);

            } 

            return '';
        }

        function confirmMsg(type, title, callback) {

            let swalObj = {
                title: title,
                icon: type ?? 'info',
                buttons:["Cancelar", "Aceptar"],
                closeOnEsc: false,
                closeOnClickOutside: false,
            };

            swal(swalObj).then((resp) => {
                callback(resp);
            }).catch(swal.noop);
        }

        function infoMsg(type, title, msg = '', timer = null, callback = null) {

            let swalObj = {
                title: title,
                icon: type ?? 'info',
                // buttons: false,
                closeOnEsc: false,
                closeOnClickOutside: false,
                timer: timer,
                content: {
                    element: "div",
                    attributes: {
                        innerHTML:"<p class='text-response'>"+msg ?? "¡Cambios guardados exitosamente!"+"</p>"
                    },
                }
            };

            if(callback) {
                swal(swalObj).then((resp) => {
                    callback(resp);
                }).catch(swal.noop);
            } else {
                swal(swalObj).catch(swal.noop);
            }
        }

        function capitalizeFirstsLetter(string) {
            let auxStr = "";
            string.split(" ").forEach(element => {
                if(auxStr != "") {
                    auxStr += " ";
                }
                auxStr += element.charAt(0).toUpperCase() + element.slice(1).toLowerCase();
            });
            return auxStr.trim();
        }

        function getToday() {
            let $this = this;
            $("#today").html(dateFormatFromDate(new Date(), "7"));
            $("#fechaPrometidaPedido").prop("min", dateFormatFromDate(new Date(), "2"));
            setTimeout(function () {
                $this.getToday();
            }, 1000);
        }

        function confirmarServicio($this) {
            let servicio = $($this).closest("tr").data("item");
            console.log(servicio);
            loadMsg();
            $("#dataPedidosCliente").html(servicio.id_cliente + " - " + servicio.nombre_cliente);
            $("#dataPedidosTelefono").html(servicio.telefono.trim());
            $("#dataPedidosDireccion").html(getDireccionFormat(servicio, "pedido"));

            $("#noPedido").html(servicio.documentNumber);
            $("#fechaSolicitudPedido").html(dateFormatFromDate(servicio.fecha_solicitud, '5'));

            $("#fechaPrometidaPedido").val(dateFormatFromDate(servicio.fecha_prometida, "2"));
            $("#desdePedido").val(servicio.desde ? getTimeFromString(servicio.desde) : null);
            $("#hastaPedido").val(servicio.hasta ? getTimeFromString(servicio.hasta) : null);
            $("#zonaVentaPedido").val(servicio.zona);
            $("#observacionesPagoPedido").val(servicio.observaciones);
            $('.productosMetodoPagoForm tbody').children("tr").remove();
            $('.productosMetodoPagoForm').parent().parent().addClass('d-none');
            $("#sinMetodosPago").removeClass('d-none');
            if(servicio.objPagos) {
                let aux = JSON.parse(servicio.objPagos);
                let total = 0;
                if(aux.pago) {
                    aux.pago.forEach(element => {
                        $(".productosMetodoPagoForm tbody").append(
                            '<tr data-metodo-id='+element.tipo_pago+' class="metodo-item" data-metodo=' + "'" + JSON.stringify(element) + "'" + '>' +
                                '<td>'+getMetodoPagoNombre(element)+'</td>'+
                                '<td class="text-center">'+(element.folio ? element.folio : 'No aplica')+'</td>'+
                                '<td class="text-center" data-total='+element.monto+'>$'+element.monto+' mxn</td>'+
                                '<td class="text-center">'+
                                    '<button class="btn btn-sm btn-danger delete-metodo-pago" data-table-ref=".productosMetodoPagoForm" data-metodo-id='+element.tipo_pago+'> <i class="fa-solid fa-trash-can"></i> </button>'+
                                '</td>'+
                            '</tr>'
                        );
                        total = total + parseFloat(element.monto);
                    });
                    $('.productosMetodoPagoForm').parent().parent().removeClass('d-none');
                    $("#sinMetodosPago").addClass('d-none');
                }
                
                total = total.toFixed(2);
                $('.productosMetodoPagoForm').children('tfoot').find('td.total').data('total', total);
                $('.productosMetodoPagoForm').find('td.total').text('$'+total+' mxn');
            }
            let settings = {
                url      : urlGetItemsOpp,
                method   : 'POST',
                data     : JSON.stringify({opp : servicio.no_pedido}),
            }

            setAjax(settings).then((response) => {
                if(response.success) {
                    servicio.articulos = response.data;
                } else {
                    servicio.articulos = [];
                }
                if(response.success) {
                    $('.productosCilindroPedidoForm, .productosEstacionarioPedidoForm').parent().parent().addClass('d-none');
                    $('.productosCilindroPedidoForm tbody, .productosEstacionarioPedidoForm tbody').children("tr").remove();
                    var table = $('.productosCilindroPedidoForm');
                    response.data.forEach(element => {
                        if(element.itemId == articuloGasLp) {
                            table = $('.productosEstacionarioPedidoForm');
                        }
                    });
                    table.parent().parent().removeClass('d-none');
                    let total = 0,
                        descuento = 0;
                    if(response.data.length > 0) {
                        $('#sinProductos').addClass('d-none');
                    } else {
                        $('#sinProductos').removeClass('d-none');
                    }
                    response.data.forEach(articulo => {
                        if(articulo.itemId != defDescuentoID) {
                            articulo.capacity = articulo.typeId != "2" ? (articulo.capacidad ? articulo.capacidad : '0') : (articulo.quantity ? articulo.quantity : '0');
                            articulo.article = articulo.itemId ? articulo.itemId : '0';
                            articulo.amount = articulo.amount ? parseFloat(articulo.amount) : 0;
                            articulo.taxAmount = articulo.taxAmount ? parseFloat(articulo.taxAmount) : 0;
                            if(table.hasClass('productosCilindroPedidoForm')) {
                                $(".productosCilindroPedidoForm tbody").append(
                                    '<tr data-item-id='+articulo.itemId+' class="product-item" data-item=' + "'" + JSON.stringify(articulo) + "'" + '>' +
                                        '<td class="text-center">'+articulo.item+'</td>'+
                                        '<td class="text-center">'+articulo.quantity+'</td>'+
                                        '<td class="text-center">'+articulo.capacidad+' kg</td>'+
                                        '<td class="text-center" data-total='+(articulo.amount+articulo.taxAmount)+'>$'+(articulo.amount+articulo.taxAmount).toFixed(2)+' mxn</td>'+
                                        '<td class="text-center">'+
                                            (articulo.typeId != "5" ? '<button class="btn btn-sm btn-info edit-producto-cil"> <i class="fa fa-pen-to-square"></i> </button> ' : '') +
                                            '<button class="btn btn-sm btn-danger delete-producto-cil" data-table-ref=".productosCilindroPedidoForm" data-item-id='+articulo.article+'> <i class="fa-solid fa-trash-can"></i> </button>'+
                                        '</td>'+
                                    '</tr>'
                                );
                            } else {
                                $(".productosEstacionarioPedidoForm tbody").append(
                                    '<tr data-item-id='+articulo.itemId+' class="product-item" data-item=' + "'" + JSON.stringify(articulo) + "'" + '>' +
                                        '<td>'+articulo.item+'</td>'+
                                        '<td class="text-center">1</td>'+
                                        '<td class="text-center">'+articulo.quantity+'</td>'+                                        
                                        '<td class="text-center" data-total='+(articulo.amount+articulo.taxAmount)+'>$'+(articulo.amount+articulo.taxAmount)+' mxn</td>'+
                                        '<td class="text-center">'+
                                            '<button class="btn btn-sm btn-info edit-producto-est"> <i class="fa fa-pen-to-square"></i> </button> '+
                                            '<button class="btn btn-sm btn-danger delete-producto-est" data-table-ref=".productosEstacionarioPedidoForm" data-item-id='+articulo.article+'> <i class="fa-solid fa-trash-can"></i> </button>'+
                                        '</td>'+
                                    '</tr>'
                                );
                            }
                            
                            total = total + (articulo.amount+articulo.taxAmount);
                        } else {
                            descuento = Number(articulo.amount.toString().replace('-',''));
                        }                        
                    });

                    descuento = descuento.toFixed(2);
                    table.children('tfoot').find('td.descuento').data('descuento', descuento);
                    table.children('tfoot').find('td.descuento').text('$'+descuento+' mxn');  

                    total = total.toFixed(2);
                    table.children('tfoot').find('td.total').data('total', total);
                    table.children('tfoot').find('td.total').text('$'+total+' mxn');            
                }
                

                $("#formConfirmarPedidos").data("item", servicio);
                $("#formConfirmarPedidos").modal("show");
                swal.close();
            }).catch((error) => {
                console.log(error);
                swal.close();
            });
            
        }

        function getMetodoPagoNombre(item) {
            let aux = "No encontrado";
            console.log(item);
            if(item.tipo_pago) {
                methodPayments.forEach(element => {
                    if(element.id == item.tipo_pago) {
                        aux = element.method;
                    }
                });
            }
            return aux;
        }

        function getMethodPayments() {
            let dataListMethodPayments = {
                "requestType" : 'getMethodPayments'
            };

            let settings = {
                url      : urlGetMethodPayments,
                method   : 'GET',
                data     : JSON.stringify(dataListMethodPayments),
            }

            setAjax(settings).then((response) => {
                $('#metodoPagoPedido').children('option').remove();
                $("select#metodoPagoPedido").append('<option value="">Seleccione una opción</option>')
                if(response.success) {                                        
                    response.data.forEach(element => {
                        methodPayments.push(element);
                        if ( parseInt(element.id) != metodoMultiple ) {// Si es diferente a método de pago múltiple, se añade al select
                            $("#metodoPagoPedido").append(
                                '<option value='+element.id+'>'+element.method+'</option>'
                            );
                        }
                    });
                }
                readyInit()
            }).catch((error) => {
                console.log(error);
            });
        }

        $("#btnConfirmarPedido").click(function() {
            let servicio = $("#formConfirmarPedidos").data("item");
            let tablaProd        = null;
            // Define cuál tabla de productos es la que se usará para calcular totales y descuentos
            if (! $('.productosEstacionarioPedidoForm').parent().parent().hasClass('d-none') ) { // Estacionario
                tablaProd = $('.productosEstacionarioPedidoForm');
            } else if (! $('.productosCilindroPedidoForm').parent().parent().hasClass('d-none') ) { // Cilindro
                tablaProd = $('.productosCilindroPedidoForm');
            }
            if(!$("#fechaPrometidaPedido").val() ||
            !$("#desdePedido").val() ||
            !$("#hastaPedido").val() || !tablaProd) {
                let aux = "<ul>";
                if(!$("#fechaPrometidaPedido").val()) {
                    aux += "<li>Fecha prometida</li>";
                }
                if(!$("#desdePedido").val()) {
                    aux += "<li>Desde</li>";
                }
                if(!$("#hastaPedido").val()) {
                    aux += "<li>Hasta</li>";
                }
                if(!tablaProd) {
                    aux += "<li>Agregue al menos un producto a la lista</li>";
                }
                aux += "</ul>";
                infoMsg('warning', 'Campos requeridos:', aux);
                return;
            }
            confirmMsg("warning", "¿Seguro que desea confirmar el servicio?", function(resp) {
                if(resp) {
                    let auxArtSend = [];
                    let articulosArr = [];           
                    let pagosArr     = [];         
                    let prices   = $("#formConfirmarPedidos").data("item").precioZona;
                    let dataSend = {
                        "opportunitiesUpdate": [
                            {
                                "id": servicio.no_pedido,
                                "bodyFields": {
                                    "expectedclosedate": dateFormatFromDate($("#fechaPrometidaPedido").val(), "5"),
                                    "custbody_ptg_entre_las": formatTime( $('#desdePedido').val() ),
                                    "custbody_ptg_y_las" : formatTime( $('#hastaPedido').val()),
                                    "memo": $('#observacionesPagoPedido').val(),
                                    "custbody_ptg_estado_pedido": idPorNotificar,
                                    'custbody_ptg_opcion_pago_obj': ''
                                },
                                "lines": [
                                    
                                ]
                            }
                        ]
                    };

                    // Agrega la lista de métodos de pago
                    $('table.productosMetodoPagoForm > tbody  > tr.metodo-item').each(function() {
                        let metodoObj = $(this).data('metodo');

                        if ( metodoObj.tipo_pago == '9' ) {// El método de pago es crédito
                            totalConCredito = parseFloat( Number(metodoObj.monto) ).toFixed(2);
                        }
                        pagosArr.push( $( this ).data('metodo') );
                    });
                    
                    // Agrega la lista de artículos
                    tablaProd.children('tbody').children('tr.product-item').each(function(e) {
                        articulosArr.push( $(this).data('item') );
                    });
                    
                    servicio.articulos.forEach(element => {
                        let existArt = false; 
                        element.nuevo = false;
                        articulosArr.forEach(element2 => {
                            if(element.article && element2.article && element.article == element2.article) {
                                existArt = true;
                                element.quantity = element2.quantity;
                            }
                        });
                        if(existArt) {
                            element.update = true;
                            element.delete = false;
                        } else {
                            element.update = false;
                            element.delete = true;                            
                        }
                        if(element.itemId == defDescuentoID) {
                            element.article = element.itemId
                            element.quantity = "";
                            element.rate = Number(tablaProd.find(".descuento").data("descuento") * -1);
                            element.delete = false;
                            element.update = true;
                        } else if(element.article == articuloGasLp) {
                            element.rate = Number(prices);
                        } else if(element.typeId == 5) {
                            element.rate = Number(element.amount);
                        } else if(element.tipo == 5) {
                            element.rate = Number(element.precio) / 1.16;
                        } else {
                            element.rate = Number(element.capacity) * Number(prices);
                        }
                        auxArtSend.push(element);
                    });
                    
                    articulosArr.forEach(element => {
                        let existArt = false; 
                        auxArtSend.forEach(element2 => {
                            if(element.article && element2.article && element.article == element2.article) {
                                existArt = true;
                            }
                        });
                        if(!existArt) {
                            if(element.itemId == defDescuentoID) {
                                element.article = element.itemId
                                element.quantity = "";
                                element.rate = Number(tablaProd.find(".descuento").data("descuento") * -1);
                                element.delete = false;
                                element.update = true;
                                element.nuevo = true;
                            } else if(element.article == articuloGasLp) {
                                element.rate = Number(prices);
                            } else if(element.typeId == 5) {
                                element.rate = Number(element.amount);
                            } else if(element.tipo == 5) {
                                element.rate = Number(element.precio) / 1.16;
                            } else {
                                element.rate = Number(element.capacity) * Number(prices);
                            }
                            auxArtSend.push(element);
                        }                        
                    });
                    dataSend.opportunitiesUpdate[0].linesMonitor = auxArtSend;
                    dataSend.opportunitiesUpdate[0].bodyFields.custbody_ptg_opcion_pago_obj = JSON.stringify({pago:pagosArr})
                    console.log(dataSend);
                    loadMsg();
                    let settings = {
                        url      : urPutOppMonitor,
                        method   : 'PUT',
                        data: JSON.stringify(dataSend)
                    }
                    setAjax(settings).then((response) => {
                        if(response.success) {
                            swal.close();
                            infoMsg('success', '', "Servicio confirmado de manera correcta", null, function(resp) {
                                $("#formConfirmarPedidos").modal('hide');
                                getServicios();
                            }); 
                        } else {
                            swal.close();
                            infoMsg('error', 'Error:', "Ocurrio un error al tratar de confirmar el servicio");
                        }            
                    }).catch((error) => {
                        infoMsg('error', 'Error:', "Ocurrio un error al tratar de confirmar el servicio");
                        console.log(error);
                        swal.close();
                    });
                }
            });
        });

        function verDetalles($this) {
            let pedido = $($this).closest("tr").data("item");
            loadMsg();
            console.log(pedido);
            $("#verDetallesCliente").html(pedido.id_cliente + " - " + pedido.nombre_cliente);
            $("#verDetallesTelefono").html(pedido.telefono.trim());
            $("#verDetallesDireccion").html(getDireccionFormat(pedido));
            $("#verDetallesTipoServicio").html(pedido.tipo_cliente.trim());

            $("#verDetallesServicio").html(pedido.documentNumber);
            $("#verDetallesFechaPrometida").html(dateFormatFromDate(pedido.fecha_prometida, '5'));
            $("#verDetallesTipoProducto").html("");
            vrTiposServicios.forEach(element => {
                if(pedido.servicio == element.id) {
                    $("#verDetallesTipoProducto").html(element.nombre);
                }
            });
            if($("#verDetallesTipoProducto").html().trim() == "") {
                $("#verDetallesTipoProducto").html("Desconocido");
            }
            $("#verDetallesEstadoSeguimiento").html(pedido.estado);
            $("#verDetallesObservaciones").html(pedido.observaciones ? pedido.observaciones : 'Sin observaciones');

            let settings = {
                url      : urlGetItemsOpp,
                method   : 'POST',
                data     : JSON.stringify({opp : pedido.no_pedido}),
            }

            setAjax(settings).then((response) => {
                if(response.success) {
                    $('.productosCilindroPedido, .productosEstacionarioPedido').parent().parent().addClass('d-none');
                    $('.productosCilindroPedido tbody, .productosEstacionarioPedido tbody').children("tr").remove();
                    var table = $('.productosCilindroPedido');
                    response.data.forEach(element => {
                        if(element.itemId == articuloGasLp) {
                            table = $('.productosEstacionarioPedido');
                        }
                    });
                    table.parent().parent().removeClass('d-none');
                    let total = 0;
                    response.data.forEach(articulo => {
                        articulo.amount = articulo.amount ? parseFloat(articulo.amount) : 0;
                        articulo.taxAmount = articulo.taxAmount ? parseFloat(articulo.taxAmount) : 0;
                        if(table.hasClass('productosCilindroPedido')) {
                            $(".productosCilindroPedido tbody").append(
                                '<tr data-item-id='+articulo.itemId+' class="product-item" data-item=' + "'" + JSON.stringify(articulo) + "'" + '>' +
                                    '<td class="text-center">'+articulo.item+'</td>'+
                                    '<td class="text-center">'+articulo.quantity+'</td>'+
                                    '<td class="text-center">'+articulo.capacidad+' kg</td>'+
                                    '<td class="text-center" data-total='+(articulo.amount+articulo.taxAmount)+'>$'+(articulo.amount+articulo.taxAmount).toFixed(2)+' mxn</td>'+
                                '</tr>'
                            );
                        } else {
                            $(".productosEstacionarioPedido tbody").append(
                                '<tr data-item-id='+articulo.itemId+' class="product-item" data-item=' + "'" + JSON.stringify(articulo) + "'" + '>' +
                                    '<td>'+articulo.item+'</td>'+
                                    '<td class="text-center">'+articulo.quantity+'</td>'+
                                    '<td class="text-center">1</td>'+
                                    '<td class="text-center" data-total='+(articulo.amount+articulo.taxAmount)+'>$'+(articulo.amount+articulo.taxAmount)+' mxn</td>'+
                                '</tr>'
                            );
                        }
                        
                        total = total + (articulo.amount+articulo.taxAmount);
                    });

                    total = total.toFixed(2);
                    table.children('tfoot').find('td.total').data('total', total);
                    table.children('tfoot').find('td.total').text('$'+total+' mxn');            
                }
                $("#formVerDetallesPedidos").modal("show");
                swal.close();
            }).catch((error) => {
                console.log(error);
                swal.close();
            });
            
        }

        function readyInit() {
            let totalServices = 8;
            countServices += 1;
            if(countServices == totalServices) {
                getServicios();
            }
        }
        getToday();
        loadMsg();
        getPlantas();
        getTiposServicios();
        getStatusOportunidad();
        getListCancellReason();
        getZonas();
        getMethodPayments();
        getArticulos();
        getStatusCallAlert();
    </script>

</body>

</html>